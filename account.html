<!DOCTYPE html>
<html lang="en">
<head>
<!-- PWA Manifest -->
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#8b5cf6">
<meta name="apple-mobile-web-app-capable" content="yes">

    <link rel="stylesheet" href="styles.css">
    
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-K0G9YRD39L"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-K0G9YRD39L');
    </script>

    <!-- Lemon Squeezy -->
    <script src="https://assets.lemonsqueezy.com/lemon.js" defer></script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Account Management | DMTools.fun account status, plan infomation, usage tracking and billing history </title>
    <meta name="description" content="Manage your DMTools.fun account, view usage statistics, upgrade plans, and access billing information.">
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üí¨</text></svg>">
    

    
  <style>
    /* PAGE-SPECIFIC: Account Management */
    
    .account-header {
        text-align: center;
        margin-bottom: 3rem;
        padding: 2rem 0;
    }

    .account-header h1 {
        font-size: 2.5rem;
        font-weight: 800;
        margin-bottom: 0.5rem;
        background: linear-gradient(135deg, #ffffff, #8b5cf6);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .account-header p {
        color: var(--text-muted);
        font-size: 1.1rem;
    }

    /* Account Grid */
    .account-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        margin-bottom: 3rem;
    }

    .account-card {
        background: var(--bg-input);
        border-radius: 16px;
        padding: 2rem;
        border: 1px solid var(--border-medium);
        box-shadow: var(--shadow-md);
    }

    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }

    .card-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-primary);
    }

    .card-action {
        background: none;
        border: none;
        color: var(--primary);
        cursor: pointer;
        font-size: 0.9rem;
        text-decoration: underline;
    }

    .card-action:hover {
        color: var(--primary-light);
    }

    /* Profile Section */
    .profile-info {
        display: grid;
        gap: 1rem;
    }

    .info-item {
        display: flex;
        justify-content: space-between;
        padding: 0.75rem 0;
        border-bottom: 1px solid var(--border-medium);
    }

    .info-item:last-child {
        border-bottom: none;
    }

    .info-label {
        color: var(--text-muted);
        font-weight: 500;
    }

    .info-value {
        color: var(--text-primary);
        font-weight: 600;
    }

    /* Profile Edit Form */
    .profile-edit-form {
        display: grid;
        gap: 1rem;
    }

    .form-actions {
        display: flex;
        gap: 1rem;
        margin-top: 1rem;
    }

    /* Plan Section */
    .current-plan {
        text-align: center;
        margin-bottom: 2rem;
    }

    .plan-badge {
        background: linear-gradient(135deg, var(--primary), var(--primary-dark));
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 50px;
        font-size: 0.9rem;
        font-weight: 700;
        display: inline-block;
        margin-bottom: 1rem;
    }

    .plan-price {
        font-size: 2rem;
        font-weight: 800;
        color: var(--primary);
        margin-bottom: 0.5rem;
    }

    .plan-features {
        list-style: none;
        padding: 0;
        margin: 1rem 0;
    }

    .plan-features li {
        padding: 0.5rem 0;
        color: var(--text-secondary);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .plan-features li::before {
        content: '‚úì';
        color: var(--success);
        font-weight: bold;
    }

    /* Usage Statistics */
    .usage-stats {
        display: grid;
        gap: 1.5rem;
    }

    .stat-item {
        background: var(--bg-card);
        border-radius: 12px;
        padding: 1.5rem;
        border: 1px solid var(--bg-light);
    }

    .stat-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .stat-title {
        font-weight: 600;
        color: var(--text-primary);
    }

    .stat-value {
        font-size: 1.5rem;
        font-weight: 800;
        color: var(--primary);
    }

    .progress-bar {
        width: 100%;
        height: 8px;
        background: var(--bg-input);
        border-radius: 4px;
        overflow: hidden;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(135deg, var(--primary), var(--accent));
        transition: width 0.3s ease;
        border-radius: 4px;
    }

    /* Billing History */
    .billing-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
    }

    .billing-table th,
    .billing-table td {
        padding: 1rem;
        text-align: left;
        border-bottom: 1px solid var(--border-medium);
    }

    .billing-table th {
        color: var(--text-muted);
        font-weight: 600;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .billing-table td {
        color: var(--text-primary);
    }

    .status-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 50px;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    .status-paid {
        background: var(--success-bg);
        color: var(--success);
        border: 1px solid var(--success);
    }

    .status-pending {
        background: var(--warning-bg);
        color: var(--warning);
        border: 1px solid var(--warning);
    }

    /* Upgrade Section */
    .upgrade-section {
        margin-top: 2rem;
        padding-top: 2rem;
        border-top: 1px solid var(--border-medium);
    }

    .plans-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1.5rem;
        margin-top: 2rem;
    }

    .plan-card {
        background: var(--bg-card);
        border-radius: 16px;
        padding: 2rem;
        border: 2px solid var(--bg-light);
        text-align: center;
        position: relative;
        transition: all 0.3s ease;
    }

    .plan-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-lg);
    }

    .plan-card.featured {
        border-color: var(--primary);
        background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), var(--bg-input));
    }

    .plan-card.current-plan-card {
        border-color: var(--success);
        background: linear-gradient(135deg, var(--success-bg), var(--bg-input));
    }

    .plan-name {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
        color: var(--text-primary);
    }

    .plan-card-price {
        font-size: 2.5rem;
        font-weight: 800;
        color: var(--primary);
        margin-bottom: 1rem;
    }

    .plan-card.current-plan-card .plan-card-price {
        color: var(--success);
    }

    /* Loading State */
    .loading {
        text-align: center;
        padding: 3rem;
        color: var(--text-muted);
    }

    /* Auth Modal Overrides */
    .auth-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: var(--z-modal);
        justify-content: center;
        align-items: center;
        backdrop-filter: blur(4px);
    }

    .auth-modal.show {
        display: flex;
    }

    .auth-modal-content {
        background: linear-gradient(135deg, var(--bg-input), var(--bg-footer));
        border-radius: var(--radius-xl);
        padding: 2rem;
        max-width: 450px;
        width: 90%;
        border: 1px solid var(--border-medium);
        position: relative;
    }

    .auth-modal-header {
        margin-bottom: 1.5rem;
    }

    .auth-modal-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 0.5rem;
    }

    .auth-modal-subtitle {
        color: var(--text-muted);
    }

    .name-fields {
        display: grid;
        gap: 1rem;
    }

    .error-message {
        background: var(--error-bg);
        border: 1px solid var(--error);
        color: var(--error);
        padding: 0.75rem;
        border-radius: var(--radius-md);
        margin-bottom: 1rem;
    }

    /* Notification */
    .notification {
        position: fixed;
        top: 100px;
        right: 20px;
        background: var(--bg-input);
        border: 1px solid var(--border-medium);
        border-radius: var(--radius-lg);
        padding: 1rem 1.5rem;
        color: var(--text-primary);
        z-index: var(--z-notification);
        max-width: 400px;
        opacity: 0;
        transform: translateX(100%);
        transition: all 0.3s ease;
    }

    .notification.show {
        opacity: 1;
        transform: translateX(0);
    }

    .notification.success {
        border-color: var(--success);
        background: var(--success-bg);
        color: var(--success);
    }

    .notification.error {
        border-color: var(--error);
        background: var(--error-bg);
        color: var(--error);
    }

    /* Responsive */
    @media (max-width: 768px) {
        .account-grid {
            grid-template-columns: 1fr;
        }

        .form-actions {
            flex-direction: column;
        }

        .form-actions .btn {
            width: 100%;
        }
    }
</style>
</head>
<body>
   <!-- Header -->
<header class="header">
    <div class="nav-container">
        <a href="/" class="logo">DMTools.fun</a>
        <div class="auth-buttons" id="authButtons">
            <button class="mobile-menu-btn" onclick="toggleMobileMenu()" aria-label="Menu">‚ò∞</button>
    
<script>
  window.location.replace('/packs.html');
</script>

  
    <nav class="mobile-nav" id="mobileNav">
        <a href="/app.html" class="tab-btn">Generator</a>
        <a href="/presets.html" class="tab-btn">Templates</a>
        <a href="/packs.html" class="tab-btn">Response Packs</a>
        <a href="/pricing.html" class="tab-btn">Pricing</a>
</nav>
</header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <!-- Account Header -->
            <div class="account-header">
                <h1>Account Management</h1>
                <p>Manage your profile, view usage statistics, and upgrade your plan</p>
            </div>

            <!-- Loading State -->
            <div id="loading-state" class="loading">
                <div class="spinner"></div>
                Loading account information...
            </div>

            <!-- Account Content -->
            <div id="account-content" class="hidden">
                <!-- Account Grid -->
                <div class="account-grid">
                    <!-- Profile Information -->
                    <div class="account-card">
                        <div class="card-header">
                            <h2 class="card-title">Profile Information</h2>
                            <button class="card-action" onclick="toggleProfileEdit()" id="edit-profile-btn">
                                <span id="edit-profile-text">‚úèÔ∏è Edit</span>
                            </button>
                        </div>

                        <!-- Profile View -->
                        <div id="profile-view" class="profile-info">
                            <div class="info-item">
                                <span class="info-label">Email</span>
                                <span class="info-value" id="profile-email">-</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">First Name</span>
                                <span class="info-value" id="profile-first-name">-</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Last Name</span>
                                <span class="info-value" id="profile-last-name">-</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Member Since</span>
                                <span class="info-value" id="profile-created">-</span>
                            </div>
                        </div>

                        <!-- Profile Edit -->
                        <div id="profile-edit" class="profile-edit-form hidden">
                            <div class="form-group">
                                <label class="form-label">Email</label>
                                <input type="email" id="edit-email" class="form-input" disabled>
                            </div>
                            <div class="form-group">
                                <label class="form-label">First Name</label>
                                <input type="text" id="edit-first-name" class="form-input">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Last Name</label>
                                <input type="text" id="edit-last-name" class="form-input">
                            </div>
                            <div class="form-actions">
                                <button class="btn btn-primary" onclick="saveProfile()">Save Changes</button>
                                <button class="btn btn-secondary" onclick="cancelProfileEdit()">Cancel</button>
                            </div>
                        </div>
                    </div>

                    <!-- Current Plan -->
                    <div class="account-card">
                        <div class="card-header">
                            <h2 class="card-title">Current Plan</h2>
                            <button class="card-action" onclick="showUpgradeOptions()">Upgrade</button>
                        </div>

                        <div class="current-plan">
                            <div class="plan-badge" id="current-plan-badge">Free Plan</div>
                            <div class="plan-price" id="current-plan-price">$0/month</div>
                            
                            <ul class="plan-features" id="current-plan-features">
                                <!-- Features will be loaded dynamically -->
                            </ul>

                            <div id="next-billing-info" class="hidden" style="margin-top: 1rem; padding: 1rem; background: rgba(139, 92, 246, 0.1); border-radius: 8px; border: 1px solid #8b5cf6;">
                                <div style="color: #c4b5fd; font-weight: 600; margin-bottom: 0.5rem;">Next Billing</div>
                                <div id="next-billing-date" style="color: #ffffff;"></div>
                                <div id="next-billing-amount" style="color: #8b5cf6; font-weight: 700;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Usage Statistics -->
                <div class="account-card" style="margin-bottom: 2rem;">
                    <div class="card-header">
                        <h2 class="card-title">Usage Statistics</h2>
                        <span class="card-action" id="usage-last-updated">Loading...</span>
                    </div>

                    <div class="usage-stats">
                        <div class="stat-item">
                            <div class="stat-header">
                                <span class="stat-title">Monthly AI Responses</span>
                                <span class="stat-value" id="monthly-usage-text">0 / 10</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="monthly-progress" style="width: 0%"></div>
                            </div>
                        </div>

                        <div class="stat-item">
                            <div class="stat-header">
                                <span class="stat-title">Custom Templates</span>
                                <span class="stat-value" id="templates-usage-text">0 / 5</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="templates-progress" style="width: 0%"></div>
                            </div>
                        </div>

                        <div class="stat-item">
                            <div class="stat-header">
                                <span class="stat-title">Lifetime Responses Generated</span>
                                <span class="stat-value" id="total-generated">0</span>
                            </div>
                            <div style="color: #9ca3af; font-size: 0.9rem; margin-top: 0.5rem;">
                                Account active for <span id="account-age">0</span> months
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Billing History -->
                <div class="account-card">
                    <div class="card-header">
                        <h2 class="card-title">Billing History</h2>
                        <span class="card-action" id="billing-summary">Total: $0</span>
                    </div>

                    <div id="billing-loading" class="loading">
                        <div class="spinner"></div>
                        Loading billing history...
                    </div>

                    <div id="billing-content" class="hidden">
                        <table class="billing-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Description</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                    <th>Invoice</th>
                                </tr>
                            </thead>
                            <tbody id="billing-history">
                                <!-- Billing history will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>

            <!-- Unauthenticated State -->
            <div id="unauthenticated-state" class="hidden">
                <div style="text-align: center; padding: 4rem; background: #1f2937; border-radius: 16px; border: 1px solid #374151;">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">üîí</div>
                    <h2 style="color: #ffffff; margin-bottom: 1rem;">Sign In Required</h2>
                    <p style="color: #9ca3af; margin-bottom: 2rem;">
                        Please sign in to access your account management page.
                    </p>
                    <button class="btn btn-primary" data-auth="login">Sign In</button>
                </div>
            </div>
        </div>
    </main>

    <!-- Notification Container -->
    <div id="notification" class="notification"></div>

    <!-- Auth Modal -->
    <div id="auth-modal" class="auth-modal">
        <div class="auth-modal-content">
            <button class="modal-close" onclick="hideAuthModal()">√ó</button>
            <div class="auth-modal-header">
                <h2 class="auth-modal-title" id="auth-modal-title">Sign In</h2>
                <p class="auth-modal-subtitle" id="auth-modal-subtitle">Access your account</p>
            </div>

            <div id="auth-error" class="error-message hidden"></div>

            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" id="email" class="form-input" placeholder="Enter your email" />
            </div>
            
            <div class="form-group">
                <label class="form-label">Password</label>
                <input type="password" id="password" class="form-input" placeholder="Enter your password" />
            </div>
            
            <div id="name-fields" class="name-fields hidden">
                <div class="form-group">
                    <label class="form-label">First Name</label>
                    <input type="text" id="first-name" class="form-input" placeholder="First name" />
                </div>
                <div class="form-group">
                    <label class="form-label">Last Name</label>
                    <input type="text" id="last-name" class="form-input" placeholder="Last name" />
                </div>
            </div>
            
            <button class="btn btn-primary" id="auth-submit-btn" onclick="handleAuth()" style="width: 100%;">
                Sign In
            </button>
            
            <div style="text-align: center; margin-top: 1rem;">
                <p>
                    <span id="auth-switch-text">Don't have an account?</span>
                    <button id="auth-switch-btn" onclick="toggleAuthMode()" style="background: none; border: none; color: #8b5cf6; text-decoration: underline; cursor: pointer;">Sign Up</button>
                </p>
            </div>
        </div>
    </div>
<!-- Footer -->
<footer class="footer">
    <div class="container">
        <div class="footer-content">
            <div class="footer-brand">
                <h3 class="footer-logo">DMTools.fun</h3>
                <p class="footer-description">
                    AI-powered universal messaging response generator.
                </p>
            </div>
            
            <div class="footer-links">
                <div class="link-group">
                    <h4>Product</h4>
                    <a href="/app.html">Generator</a>
                    <a href="/presets.html">Templates</a>
                    <a href="/pricing.html">Pricing</a>
                    <a href="/store.html">Packs Store</a>
                </div>
                
                <div class="link-group">
                    <h4>Legal</h4>
                    <a href="/terms-of-service.html">Terms of Service</a>
                    <a href="/privacy-policy.html">Privacy Policy</a>
                    <a href="/refund-policy.html">Refund Policy</a>
                    <a href="/cookie-policy.html">Cookie Policy</a>
                </div>
                
                <div class="link-group">
                    <h4>Support</h4>
                    <a href="/contact.html">Contact Us</a>
                    <a href="mailto:admin@dmtools.fun">Email Support</a>
                </div>
            </div>
        </div>
        
        <div class="footer-bottom">
            <p class="footer-copyright">¬© 2025 DMTools.fun LLC. All rights reserved.</p>
        </div>
    </div>
</footer>
    <script>
        // Global Variables
        let currentUser = null;
        let isAuthenticated = false;
        let isLoginMode = true;
        let isEditingProfile = false;
        let usageData = null;
        let billingData = null;
        
        // FIXED API Configuration - Added /api to the base URL
        const API_BASE = 'https://dmtools-backend-production.up.railway.app/api';

    // Mobile menu toggle
    function toggleMobileMenu() {
        document.getElementById('mobileNav').classList.toggle('show');
    }
        // Initialize App
        document.addEventListener('DOMContentLoaded', initializeApp);

        async function initializeApp() {
            console.log('üöÄ Initializing DMTools Account Page...');
            
            try {
                const token = localStorage.getItem('authToken');
                if (token) {
                    try {
                        const response = await apiCall('/user/profile');
                        currentUser = response.user;
                        isAuthenticated = true;
                        await loadAccountData();
                    } catch (error) {
                        console.error('Auth validation failed:', error);
                        localStorage.removeItem('authToken');
                        showUnauthenticatedState();
                    }
                } else {
                    showUnauthenticatedState();
                }
            } catch (error) {
                console.error('App initialization error:', error);
                showUnauthenticatedState();
            }
        }
   

        // API helper function
        async function apiCall(endpoint, options = {}) {
            const token = localStorage.getItem('authToken');
            const url = API_BASE + endpoint;
            
            const config = {
                headers: {
                    'Content-Type': 'application/json',
                    ...(token ? { 'Authorization': `Bearer ${token}` } : {})
                },
                ...options,
            };

            const response = await fetch(url, config);
            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || data.message || `HTTP error! status: ${response.status}`);
            }

            return data;
        }
      

        // Account Data Loading - Now with real API calls
        async function loadAccountData() {
            if (!currentUser) return;

            try {
                // Show loading
                document.getElementById('loading-state').classList.remove('hidden');
                document.getElementById('account-content').classList.add('hidden');

                // Update user name in header
                document.getElementById('user-name').textContent = `${currentUser.first_name} ${currentUser.last_name}`;

                // Update profile information
                document.getElementById('profile-email').textContent = currentUser.email;
                document.getElementById('profile-first-name').textContent = currentUser.first_name || 'N/A';
                document.getElementById('profile-last-name').textContent = currentUser.last_name || 'N/A';
                document.getElementById('profile-created').textContent = formatDate(currentUser.created_at);

                // Update current plan
                updatePlanDisplay();

                // Load real usage statistics
                await loadUsageStatistics();

                // Load real billing history
                await loadBillingHistory();

                // Hide loading and show content
                document.getElementById('loading-state').classList.add('hidden');
                document.getElementById('account-content').classList.remove('hidden');

            } catch (error) {
                console.error('Error loading account data:', error);
                showNotification('Failed to load account data', 'error');
                
                // Hide loading and show content anyway
                document.getElementById('loading-state').classList.add('hidden');
                document.getElementById('account-content').classList.remove('hidden');
            }
        }
      
        

     // REPLACE the updatePlanDisplay() function in account.html with this:

function updatePlanDisplay() {
    const plan = currentUser.plan || 'free';
    
    console.log('üìä Updating plan display for plan:', plan);
    
    const planNames = {
        free: 'Free Plan',
        starter: 'Starter Monthly Plan', 
        startwk: 'Starter Weekly Plan',
        starter_weekly: 'Starter Weekly Plan',  // Added underscore version
        pro: 'Pro Monthly Plan',
        proAnnual: 'Pro Annual Plan',
        pro_annual: 'Pro Annual Plan',  // Added underscore version
        business: 'Business Monthly Plan',
        businessAnnual: 'Business Annual Plan',
        business_annual: 'Business Annual Plan',  // Added underscore version
        enterprise: 'Enterprise Monthly Plan',
        enterpriseAnnual: 'Enterprise Annual Plan',
        enterprise_annual: 'Enterprise Annual Plan'  // Added underscore version
    };
    
    const planPrices = {
        free: '$0/month',
        starter: '$19/month',
        startwk: '$5.99/week',
        starter_weekly: '$5.99/week',
        pro: '$59/month',
        proAnnual: '$531/year',
        pro_annual: '$531/year',
        business: '$149/month',
        businessAnnual: '$1,341/year',
        business_annual: '$1,341/year',
        enterprise: '$399/month',
        enterpriseAnnual: '$3,591/year',
        enterprise_annual: '$3,591/year'
    };
    
    const planFeatures = {
        free: ['10 responses per month', '5 custom templates', 'Basic analytics', 'Email support'],
        starter: ['100 responses per month', '10 custom templates', 'Basic analytics', 'Email support', 'Batch processing'],
        startwk: ['30 responses per week', '10 custom templates', 'Basic analytics', 'Email support', 'Batch processing'],
        starter_weekly: ['30 responses per week', '10 custom templates', 'Basic analytics', 'Email support', 'Batch processing'],
        pro: ['1,000 responses per month', '20 custom templates', 'Advanced analytics', 'Priority support', 'Batch processing', 'Export functionality', 'Chrome Extension Access'],
        proAnnual: ['1,000 responses per month', '20 custom templates', 'Advanced analytics', 'Priority support', 'Batch processing', 'Export functionality', 'Chrome Extension Access', '3 months free'],
        pro_annual: ['1,000 responses per month', '20 custom templates', 'Advanced analytics', 'Priority support', 'Batch processing', 'Export functionality', 'Chrome Extension Access', '3 months free'],
        business: ['5,000 responses per month', '200 custom templates', 'Team analytics', 'Phone support', 'Advanced batch processing', 'API access', 'Chrome Extension Access', 'White-label options'],
        businessAnnual: ['5,000 responses per month', '200 custom templates', 'Team analytics', 'Phone support', 'Advanced batch processing', 'API access', 'Chrome Extension Access', 'White-label options', '3 months free'],
        business_annual: ['5,000 responses per month', '200 custom templates', 'Team analytics', 'Phone support', 'Advanced batch processing', 'API access', 'Chrome Extension Access', 'White-label options', '3 months free'],
        enterprise: ['25,000 responses per month', 'Unlimited templates', 'Custom analytics', 'Chrome Extension Access'],
        enterpriseAnnual: ['25,000 responses per month', 'Unlimited templates', 'Custom analytics', 'Chrome Extension Access', '3 months free'],
        enterprise_annual: ['25,000 responses per month', 'Unlimited templates', 'Custom analytics', 'Chrome Extension Access', '3 months free']
    };
    
    // Update plan badge - with fallback
    const planBadge = document.getElementById('current-plan-badge');
    if (planBadge) {
        planBadge.textContent = planNames[plan] || plan || 'Free Plan';
    }
    
    // Update plan price - with fallback
    const planPrice = document.getElementById('current-plan-price');
    if (planPrice) {
        planPrice.textContent = planPrices[plan] || '$0/month';
    }
    
    // Update features - WITH SAFETY CHECK BEFORE .map()
    const featuresContainer = document.getElementById('current-plan-features');
    if (featuresContainer) {
        // Check if features exist for this plan
        if (planFeatures[plan]) {
            // Safe to use .map()
            featuresContainer.innerHTML = planFeatures[plan]
                .map(feature => `<li>${feature}</li>`)
                .join('');
        } else {
            // Fallback for unknown plans
            console.warn('‚ö†Ô∏è Unknown plan type:', plan, '- using Free plan features');
            featuresContainer.innerHTML = planFeatures['free']
                .map(feature => `<li>${feature}</li>`)
                .join('');
        }
    }
    
    console.log('‚úÖ Plan display updated successfully');
}

        // Load real usage statistics from API
        async function loadUsageStatistics() {
            try {
                const response = await apiCall('/account/usage');
                usageData = response.data;

                // Update monthly usage
                const monthlyText = `${usageData.current.monthlyUsage} / ${usageData.current.monthlyLimit}`;
                document.getElementById('monthly-usage-text').textContent = monthlyText;
                document.getElementById('monthly-progress').style.width = `${usageData.current.monthlyPercentage}%`;

                // Update templates usage
                const templatesText = `${usageData.current.templatesUsed} / ${usageData.current.templatesLimit}`;
                document.getElementById('templates-usage-text').textContent = templatesText;
                document.getElementById('templates-progress').style.width = `${usageData.current.templatesPercentage}%`;

                // Update totals
                document.getElementById('total-generated').textContent = usageData.totals.lifetimeGenerated.toLocaleString();
                document.getElementById('account-age').textContent = usageData.totals.accountAgeMonths;

                // Update last updated time
                document.getElementById('usage-last-updated').textContent = 'Updated just now';

            } catch (error) {
                console.error('Error loading usage statistics:', error);
                showNotification('Failed to load usage statistics', 'error');
                
                // Fallback to basic user data
                const monthlyUsage = currentUser.monthly_usage || 0;
                const plan = currentUser.plan || 'free';
                const limits = { free: 10, pro: 1000, business: 5000 };
                
                document.getElementById('monthly-usage-text').textContent = `${monthlyUsage} / ${limits[plan]}`;
                document.getElementById('monthly-progress').style.width = `${Math.min((monthlyUsage / limits[plan]) * 100, 100)}%`;
                document.getElementById('templates-usage-text').textContent = '0 / 5';
                document.getElementById('templates-progress').style.width = '0%';
                document.getElementById('total-generated').textContent = monthlyUsage;
                document.getElementById('account-age').textContent = '1';
            }
        }

        // Load real billing history from API
        async function loadBillingHistory() {
            try {
                document.getElementById('billing-loading').classList.remove('hidden');
                document.getElementById('billing-content').classList.add('hidden');

                const response = await apiCall('/account/billing');
                billingData = response.data;

                const billingTable = document.getElementById('billing-history');
                
                if (billingData.transactions.length === 0) {
                    billingTable.innerHTML = `
                        <tr>
                            <td colspan="5" style="text-align: center; color: #9ca3af; padding: 2rem;">
                                ${billingData.summary.currentPlan === 'Free Plan' ? 'No billing history available for free plan' : 'No transactions found'}
                            </td>
                        </tr>
                    `;
                } else {
                    billingTable.innerHTML = billingData.transactions.map(transaction => `
                        <tr>
                            <td>${formatDate(transaction.date)}</td>
                            <td>${transaction.description}</td>
                            <td>$${transaction.amount.toFixed(2)}</td>
                            <td><span class="status-badge status-${transaction.status}">${transaction.status.toUpperCase()}</span></td>
                            <td><a href="${transaction.invoiceUrl}" style="color: #8b5cf6;" ${transaction.invoiceUrl.startsWith('#') ? 'onclick="showNotification(\'Demo invoice\', \'info\'); return false;"' : ''}>Download</a></td>
                        </tr>
                    `).join('');
                }

                // Update billing summary
                document.getElementById('billing-summary').textContent = `Total: $${billingData.summary.total.toFixed(2)}`;
                
                // Show next billing info if applicable
                if (billingData.summary.nextBilling && billingData.summary.currentPlan !== 'Free Plan') {
                    document.getElementById('next-billing-info').classList.remove('hidden');
                    document.getElementById('next-billing-date').textContent = formatDate(billingData.summary.nextBilling);
                    document.getElementById('next-billing-amount').textContent = `$${billingData.summary.nextAmount.toFixed(2)}`;
                }

                document.getElementById('billing-loading').classList.add('hidden');
                document.getElementById('billing-content').classList.remove('hidden');

            } catch (error) {
                console.error('Error loading billing history:', error);
                showNotification('Failed to load billing history', 'error');
                
                // Show error state
                document.getElementById('billing-loading').classList.add('hidden');
                document.getElementById('billing-content').classList.remove('hidden');
                document.getElementById('billing-history').innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; color: #ef4444; padding: 2rem;">
                            Failed to load billing history
                        </td>
                    </tr>
                `;
            }
        }

        // Profile Management
        function toggleProfileEdit() {
            const profileView = document.getElementById('profile-view');
            const profileEdit = document.getElementById('profile-edit');
            const editText = document.getElementById('edit-profile-text');

            if (isEditingProfile) {
                // Cancel edit
                profileView.classList.remove('hidden');
                profileEdit.classList.add('hidden');
                editText.textContent = '‚úèÔ∏è Edit';
                isEditingProfile = false;
            } else {
                // Start edit
                profileView.classList.add('hidden');
                profileEdit.classList.remove('hidden');
                editText.textContent = '‚ùå Cancel';
                isEditingProfile = true;

                // Populate edit fields
                document.getElementById('edit-email').value = currentUser.email;
                document.getElementById('edit-first-name').value = currentUser.first_name || '';
                document.getElementById('edit-last-name').value = currentUser.last_name || '';
            }
        }

        function cancelProfileEdit() {
            toggleProfileEdit();
        }

        async function saveProfile() {
            const firstName = document.getElementById('edit-first-name').value.trim();
            const lastName = document.getElementById('edit-last-name').value.trim();

            if (!firstName || !lastName) {
                showNotification('Please fill in all fields', 'error');
                return;
            }

            try {
                const response = await apiCall('/user/profile', {
                    method: 'PUT',
                    body: JSON.stringify({
                        first_name: firstName,
                        last_name: lastName
                    })
                });

                currentUser.first_name = firstName;
                currentUser.last_name = lastName;
                loadAccountData();
                toggleProfileEdit();
                showNotification('Profile updated successfully!', 'success');

            } catch (error) {
                console.error('Profile update error:', error);
                showNotification(error.message || 'Failed to update profile', 'error');
            }
        }

        // Upgrade Options
        function showUpgradeOptions() {
            window.open('/pricing.html', '_blank');
        }

        function clearAuthForm() {
            document.getElementById('email').value = '';
            document.getElementById('password').value = '';
            document.getElementById('first-name').value = '';
            document.getElementById('last-name').value = '';
            document.getElementById('auth-error').classList.add('hidden');
        }

        async function handleAuth() {
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            
            if (!email || !password) {
                showError('Please fill in all required fields');
                return;
            }

            const submitBtn = document.getElementById('auth-submit-btn');
            const originalText = submitBtn.textContent;
            submitBtn.innerHTML = '<span class="spinner"></span> Processing...';
            submitBtn.disabled = true;

            try {
                let endpoint, data;
                
                if (isLoginMode) {
                    endpoint = '/user/login';
                    data = { email, password };
                } else {
                    const firstName = document.getElementById('first-name').value.trim();
                    const lastName = document.getElementById('last-name').value.trim();
                    
                    if (!firstName || !lastName) {
                        showError('Please fill in all fields');
                        return;
                    }
                    
                    endpoint = '/user/register';
                    data = { email, password, first_name: firstName, last_name: lastName };
                }

                const response = await apiCall(endpoint, {
                    method: 'POST',
                    body: JSON.stringify(data)
                });

                localStorage.setItem('authToken', response.token);
                currentUser = response.user;
                isAuthenticated = true;

                hideAuthModal();
                await loadAccountData();       
                showNotification(`Welcome${isLoginMode ? ' back' : ''}!`, 'success');

            } catch (error) {
                showError(error.message || 'Authentication failed');
            } finally {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        
        }

        function showError(message) {
            const errorDiv = document.getElementById('auth-error');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
        }

        // Utility Functions
        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }

        function logout() {
            localStorage.removeItem('authToken');
            currentUser = null;
            isAuthenticated = false;
            window.location.href = '/';
        }
    </script>
<script src="js/app-core.js"></script>
<script src="js/auth-modal.js"></script>
</body>
</html>

