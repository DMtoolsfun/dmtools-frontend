<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DMTools Admin v3</title>
 <link rel="stylesheet" href="/styles.css?v=20260212">
<style>
/* ================================
     ADMIN v3 minimal layout overrides
     Keep this small — let styles.css control the “brand”
     ================================ */

  /* basic layout (safe defaults if styles.css doesn’t define them) */
  body { margin: 0; }

.app { display: grid; grid-template-columns: 260px 1fr; min-height: 100vh; }

.sidebar { position: sticky; top: 0; height: 100vh; overflow: auto; }

.main { padding: 18px; }

/* table overflow safety */
  table { width: 100%; border-collapse: collapse; }

th, td { vertical-align: top; }

/* email body formatting */
  .emailBody { white-space: pre-wrap; }

/* Optional: if your global CSS doesn’t style <code>/<pre> well */
  code, pre { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
</style>

</head>
<body>

<!-- ============================= -->
<!-- DMTOOLS ADMIN v3 - SINGLE PAGE -->
<!-- ============================= -->

<div id="login" class="loginWrap hidden">
  <h1>DMTools Admin v3</h1>
  <div class="muted">Login uses your existing <code>/api/admin/login</code> and stores a JWT in localStorage.</div>
  <div class="row" style="margin-top:12px;">
    <input id="adminEmail" type="email" placeholder="Admin email" style="width:100%;" />
  </div>
  <div class="row">
    <input id="adminPassword" type="password" placeholder="Admin password" style="width:100%;" />
  </div>
  <div class="row">
    <button class="btn primary" id="btnLogin">Login</button>
    <button class="btn" id="btnClearToken">Clear token</button>
  </div>
  <div id="loginMsg" style="margin-top:10px;"></div>
</div>

<div id="app" class="app hidden">
  <aside class="sidebar">
    <div class="brand">DMTools Admin v3</div>
    <div class="pill"><span id="statusDot" class="dot"></span><span id="statusText">Checking session…</span></div>

    <div class="nav" style="margin-top:14px;">
      <button data-view="overview" class="active">Overview</button>
      <button data-view="users">Users</button>
      <button data-view="analytics">Analytics</button>
      <button data-view="logs">Logs</button>
      <button data-view="email">Email</button>
    </div>

    <div class="mini">
      <div><b>Backend:</b> uses your current admin endpoints</div>
      <div><b>Email:</b> requires new <code>/api/admin/email/*</code> proxy routes</div>
      <div style="margin-top:10px;">
        <button class="btn" id="btnLogout" style="width:100%;">Logout</button>
      </div>
    </div>
  </aside>

  <main class="main">
    <div class="topbar">
      <div class="search">
        <input id="userSearch" placeholder="Lookup user by ID (fastest) or email (if supported by your data)..." style="width:100%;" />
        <button class="btn primary" id="btnUserLookup">Lookup</button>
      </div>
      <div class="row">
        <span class="pill"><span class="dot ok"></span><span id="apiBaseLabel">Admin API</span></span>
      </div>
    </div>

    <div id="globalMsg"></div>

    <!-- ============================= -->
    <!-- VIEW: OVERVIEW -->
    <!-- ============================= -->
    <section id="view-overview" class="view">
      <div class="grid">
        <div class="card">
          <h2>Overview</h2>
          <div class="muted">Source: <code>GET /api/admin/dashboard</code></div>
          <div id="overviewCards" class="grid" style="margin-top:12px;"></div>
        </div>
      </div>
    </section>

    <!-- ============================= -->
    <!-- VIEW: USERS -->
    <!-- ============================= -->
    <section id="view-users" class="view hidden">
      <div class="card">
        <div class="row">
          <div>
            <h2 style="margin:0;">Users</h2>
            <div class="muted">Source: <code>GET /api/admin/users</code></div>
          </div>
          <div class="right row">
            <button class="btn" id="btnRefreshUsers">Refresh</button>
          </div>
        </div>
        <div style="margin-top:12px; overflow:auto;">
          <table>
            <thead>
              <tr>
                <th>ID</th><th>Email</th><th>Name</th><th>Plan</th><th>Sub</th><th>Monthly</th><th>Last Login</th><th>Created</th><th>Actions</th>
              </tr>
            </thead>
            <tbody id="usersTbody"></tbody>
          </table>
        </div>
      </div>

      <div class="card" style="margin-top:12px;">
        <h2>User Detail</h2>
        <div class="muted">Source: <code>GET /api/admin/users/:userId</code> + actions</div>
        <div id="userDetail" style="margin-top:10px;" class="muted">Lookup a user to see details.</div>
      </div>
    </section>

    <!-- ============================= -->
    <!-- VIEW: ANALYTICS -->
    <!-- ============================= -->
    <section id="view-analytics" class="view hidden">
      <div class="card">
        <div class="row">
          <div>
            <h2 style="margin:0;">Analytics (Backend)</h2>
            <div class="muted">Source: <code>GET /api/admin/analytics</code></div>
          </div>
          <div class="right row">
            <button class="btn" id="btnRefreshAnalytics">Refresh</button>
          </div>
        </div>

        <div class="two" style="margin-top:12px;">
          <div class="card" style="margin:0;">
            <h2>Usage by Platform (30d)</h2>
            <div style="overflow:auto;">
              <table><thead><tr><th>Platform</th><th>Count</th></tr></thead><tbody id="platTbody"></tbody></table>
            </div>
          </div>

          <div class="card" style="margin:0;">
            <h2>Top Users</h2>
            <div style="overflow:auto;">
              <table><thead><tr><th>User</th><th>Plan</th><th>Monthly Usage</th></tr></thead><tbody id="topUsersTbody"></tbody></table>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:12px;">
          <h2>Error Rate (7d)</h2>
          <div id="errorRateBox" class="muted">—</div>
        </div>
      </div>
    </section>

    <!-- ============================= -->
    <!-- VIEW: LOGS -->
    <!-- ============================= -->
    <section id="view-logs" class="view hidden">
      <div class="card">
        <div class="row">
          <div>
            <h2 style="margin:0;">Admin Logs</h2>
            <div class="muted">Source: <code>GET /api/admin/logs</code></div>
          </div>
          <div class="right row">
            <button class="btn" id="btnRefreshLogs">Refresh</button>
          </div>
        </div>
        <div style="margin-top:12px; overflow:auto;">
          <table>
            <thead>
              <tr><th>Time</th><th>Action</th><th>Admin</th><th>Details</th></tr>
            </thead>
            <tbody id="logsTbody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- ============================= -->
    <!-- VIEW: EMAIL -->
    <!-- ============================= -->
    <section id="view-email" class="view hidden">
      <div class="card">
        <div class="row">
          <div>
            <h2 style="margin:0;">Email Client (Admin)</h2>
            <div class="muted">
              Source: <code>GET /api/admin/email/inbox</code>, <code>GET /api/admin/email/message/:id</code>, <code>POST /api/admin/email/send</code>
            </div>
          </div>
          <div class="right row">
            <select id="emailLimit">
              <option value="25">25</option>
              <option value="50" selected>50</option>
              <option value="100">100</option>
            </select>
            <button class="btn" id="btnEmailRefresh">Refresh</button>
          </div>
        </div>

        <div class="split" style="margin-top:12px;">
          <div class="card" style="margin:0;">
            <div class="row">
              <h2 style="margin:0;">Inbox</h2>
              <div class="right muted" id="emailPagination">—</div>
            </div>
            <div class="emailList">
              <table>
                <thead><tr><th>ID</th><th>From</th><th>Subject</th><th>Received</th><th>Read</th><th>Del</th></tr></thead>
                <tbody id="emailTbody"></tbody>
              </table>
            </div>

            <div class="row" style="margin-top:10px;">
              <button class="btn" id="btnEmailPrev">Prev</button>
              <button class="btn" id="btnEmailNext">Next</button>
              <span class="muted" id="emailPageLabel"></span>
            </div>
          </div>

          <div class="card" style="margin:0;">
            <h2>Message</h2>
            <div id="emailMsgMeta" class="muted">Select an email to view.</div>
            <div id="emailMsgBody" class="emailBody" style="margin-top:10px;"></div>

            <hr style="border:none;border-top:1px solid rgba(255,255,255,.10);margin:14px 0;">

            <h2>Reply / Send</h2>
            <div class="row">
              <input id="sendTo" placeholder="To" style="width:100%;" />
            </div>
            <div class="row">
              <input id="sendSubject" placeholder="Subject" style="width:100%;" />
            </div>
            <div class="row">
              <textarea id="sendMessage" rows="6" placeholder="Message..." style="width:100%;"></textarea>
            </div>
            <div class="row">
              <input id="replyToId" placeholder="replyToId (optional)" style="width:100%;" />
            </div>
            <div class="row">
              <button class="btn primary" id="btnSendEmail">Send</button>
              <button class="btn" id="btnMarkRead">Mark Read</button>
              <button class="btn" id="btnMarkUnread">Mark Unread</button>
            </div>
            <div id="emailSendMsg" style="margin-top:10px;"></div>
          </div>
        </div>

      </div>
    </section>

  </main>
</div>

<script>
  // =============================
  // DMTOOLS ADMIN v3 - CLIENT
  // =============================

  const TOKEN_KEY = 'dmtools_admin_token';

  const el = (id) => document.getElementById(id);
  const setHtml = (id, html) => el(id).innerHTML = html;

  function setStatus(ok, text) {
    const dot = el('statusDot');
    dot.classList.remove('ok','bad');
    dot.classList.add(ok ? 'ok' : 'bad');
    el('statusText').textContent = text;
  }

  function showGlobal(type, msg) {
    if (!msg) { setHtml('globalMsg', ''); return; }
    const cls = type === 'ok' ? 'ok' : 'error';
    setHtml('globalMsg', `<div class="${cls}">${escapeHtml(msg)}</div>`);
  }

  function escapeHtml(s) {
    return String(s ?? '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  function getToken() {
    return localStorage.getItem(TOKEN_KEY) || '';
  }

  function setToken(t) {
    if (t) localStorage.setItem(TOKEN_KEY, t);
    else localStorage.removeItem(TOKEN_KEY);
  }

  async function api(path, opts = {}) {
    const token = getToken();
    const headers = Object.assign({ 'Content-Type': 'application/json' }, opts.headers || {});
    if (token) headers['Authorization'] = `Bearer ${token}`;

    const res = await fetch(path, Object.assign({}, opts, { headers }));
    const text = await res.text();
    let json = null;
    try { json = text ? JSON.parse(text) : null; } catch { json = { raw: text }; }

    if (!res.ok) {
      const msg = json?.error || json?.message || `Request failed (${res.status})`;
      throw new Error(msg);
    }
    return json;
  }

  function setView(name) {
    document.querySelectorAll('.nav button').forEach(b => b.classList.toggle('active', b.dataset.view === name));
    document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
    el(`view-${name}`).classList.remove('hidden');
    showGlobal(null, null);
  }

  // =============================
  // LOGIN
  // =============================

  async function doLogin() {
    const email = el('adminEmail').value.trim();
    const password = el('adminPassword').value;

    el('loginMsg').innerHTML = '';
    try {
      const out = await api('/api/admin/login', {
        method: 'POST',
        body: JSON.stringify({ email, password })
      });
      const token = out?.token || out?.adminToken;
      if (!token) throw new Error('No token returned from /api/admin/login');
      setToken(token);

      el('loginMsg').innerHTML = `<div class="ok">Login OK</div>`;
      boot();
    } catch (e) {
      el('loginMsg').innerHTML = `<div class="error">${escapeHtml(e.message)}</div>`;
    }
  }

  function doLogout() {
    setToken('');
    location.reload();
  }

  // =============================
  // OVERVIEW
  // =============================

  async function loadOverview() {
    const out = await api('/api/admin/dashboard');
    const d = out?.dashboard || out?.data?.dashboard || out?.dashboardStats || out?.data;

    if (!d) {
      setHtml('overviewCards', `<div class="error">Unexpected response from /api/admin/dashboard</div>`);
      return;
    }

    const items = [
      ['Total Users', d.totalUsers],
      ['Active Users (30d)', d.activeUsers],
      ['Active Subs', d.activeSubscriptions],
      ['API Calls Today', d.apiCallsToday],
      ['API Calls (7d)', d.apiCallsWeek],
      ['New Users Today', d.newUsersToday],
      ['Estimated Revenue', d.estimatedRevenue]
    ];

    setHtml('overviewCards', items.map(([k,v]) => `
      <div class="card" style="grid-column: span 3; margin:0;">
        <div class="muted">${escapeHtml(k)}</div>
        <div style="font-size:22px;font-weight:800;margin-top:6px;">${escapeHtml(v ?? '—')}</div>
      </div>
    `).join(''));
  }

  // =============================
  // USERS
  // =============================

  async function loadUsers() {
    const out = await api('/api/admin/users');
    const users = out?.users || [];
    const tbody = users.map(u => `
      <tr>
        <td>${escapeHtml(u.id)}</td>
        <td>${escapeHtml(u.email)}</td>
        <td>${escapeHtml((u.first_name||'') + ' ' + (u.last_name||''))}</td>
        <td>${escapeHtml(u.plan)}</td>
        <td>${escapeHtml(u.subscription_status || '')}</td>
        <td>${escapeHtml(u.monthly_usage ?? '')}</td>
        <td>${escapeHtml(u.last_login || '')}</td>
        <td>${escapeHtml(u.created_at || '')}</td>
        <td>
          <button class="btn" onclick="selectUser('${u.id}')">Open</button>
        </td>
      </tr>
    `).join('');
    setHtml('usersTbody', tbody || `<tr><td colspan="9" class="muted">No users returned.</td></tr>`);
  }

  window.selectUser = async function(userId) {
    try {
      const out = await api(`/api/admin/users/${encodeURIComponent(userId)}`);
      const u = out?.user || out?.details || out?.data || out;
      const usage = u?.usage || out?.usage;

      setHtml('userDetail', `
        <div class="row">
          <span class="pill"><b>ID:</b>&nbsp;${escapeHtml(userId)}</span>
          <span class="pill"><b>Email:</b>&nbsp;${escapeHtml(u?.email || '')}</span>
          <span class="pill"><b>Plan:</b>&nbsp;${escapeHtml(u?.plan || '')}</span>
          <span class="pill"><b>Sub:</b>&nbsp;${escapeHtml(u?.subscription_status || '')}</span>
          <span class="pill"><b>Status:</b>&nbsp;${escapeHtml(u?.status || '')}</span>
        </div>

        <div class="row" style="margin-top:10px;">
          <select id="planSelect">
            <option value="free">free</option>
            <option value="starter">starter</option>
            <option value="starter_weekly">starter_weekly</option>
            <option value="pro">pro</option>
            <option value="pro_weekly">pro_weekly</option>
            <option value="business">business</option>
            <option value="business_weekly">business_weekly</option>
            <option value="enterprise">enterprise</option>
          </select>
          <button class="btn primary" onclick="updatePlan('${userId}')">Update Plan</button>
          <button class="btn" onclick="resetUsage('${userId}')">Reset Usage</button>
          <button class="btn danger" onclick="deleteUser('${userId}')">Delete User</button>
        </div>

        <div class="card" style="margin-top:12px;">
          <h2>Raw User Object</h2>
          <pre style="white-space:pre-wrap;font-size:12px;line-height:1.4;margin:0;">${escapeHtml(JSON.stringify(out, null, 2))}</pre>
        </div>
      `);

      const planSel = document.getElementById('planSelect');
      if (planSel && u?.plan) planSel.value = u.plan;

      showGlobal('ok', `Loaded user ${userId}`);
    } catch (e) {
      showGlobal('error', e.message);
    }
  }

  window.updatePlan = async function(userId) {
    try {
      const plan = document.getElementById('planSelect').value;
      await api(`/api/admin/users/${encodeURIComponent(userId)}/plan`, {
        method: 'PUT',
        body: JSON.stringify({ plan })
      });
      showGlobal('ok', `Plan updated to ${plan}`);
      await loadUsers();
      await selectUser(userId);
    } catch (e) {
      showGlobal('error', e.message);
    }
  }

  window.resetUsage = async function(userId) {
    try {
      await api(`/api/admin/users/${encodeURIComponent(userId)}/reset-usage`, { method: 'POST' });
      showGlobal('ok', `Usage reset for user ${userId}`);
      await selectUser(userId);
    } catch (e) {
      showGlobal('error', e.message);
    }
  }

  window.deleteUser = async function(userId) {
    if (!confirm(`Delete user ${userId}? This cannot be undone.`)) return;
    try {
      await api(`/api/admin/users/${encodeURIComponent(userId)}`, { method: 'DELETE' });
      showGlobal('ok', `User ${userId} deleted`);
      await loadUsers();
      setHtml('userDetail', `<div class="muted">Lookup a user to see details.</div>`);
    } catch (e) {
      showGlobal('error', e.message);
    }
  }

  // basic lookup: ID first, fallback tries /api/admin/users/:userId only
  async function lookupUser() {
    const q = el('userSearch').value.trim();
    if (!q) return;

    // If it looks like an integer, treat as ID
    if (/^\d+$/.test(q)) {
      await selectUser(q);
      setView('users');
      return;
    }

    // Email lookup: your current backend does not expose /lookup, so do a client-side search from /users.
    // This keeps us “endpoints-first” without adding new backend endpoints yet.
    try {
      const out = await api('/api/admin/users');
      const users = out?.users || [];
      const hit = users.find(u => String(u.email || '').toLowerCase() === q.toLowerCase());
      if (!hit) throw new Error('User not found by email (try user ID)');
      await selectUser(hit.id);
      setView('users');
    } catch (e) {
      showGlobal('error', e.message);
    }
  }

  // =============================
  // ANALYTICS
  // =============================

  async function loadAnalytics() {
    const out = await api('/api/admin/analytics');
    const a = out?.analytics;
    if (!a) { showGlobal('error', 'Unexpected /api/admin/analytics response'); return; }

    setHtml('platTbody', (a.usageByPlatform || []).map(r => `
      <tr><td>${escapeHtml(r.platform)}</td><td>${escapeHtml(r.count)}</td></tr>
    `).join('') || `<tr><td colspan="2" class="muted">No data</td></tr>`);

    setHtml('topUsersTbody', (a.topUsers || []).map(u => `
      <tr><td>${escapeHtml(u.email || u.id)}</td><td>${escapeHtml(u.plan)}</td><td>${escapeHtml(u.monthly_usage)}</td></tr>
    `).join('') || `<tr><td colspan="3" class="muted">No data</td></tr>`);

    const er = a.errorRate || {};
    setHtml('errorRateBox', `
      <div class="row">
        <span class="pill"><b>Errors:</b>&nbsp;${escapeHtml(er.errors ?? '—')}</span>
        <span class="pill"><b>Total:</b>&nbsp;${escapeHtml(er.total ?? '—')}</span>
        <span class="pill"><b>%:</b>&nbsp;${escapeHtml(er.percentage ?? '—')}</span>
      </div>
    `);
  }

  // =============================
  // LOGS
  // =============================

  async function loadLogs() {
    const out = await api('/api/admin/logs');
    const logs = out?.logs || [];
    setHtml('logsTbody', logs.map(l => `
      <tr>
        <td>${escapeHtml(l.timestamp || '')}</td>
        <td>${escapeHtml(l.action || '')}</td>
        <td>${escapeHtml(l.admin_email || l.admin || '')}</td>
        <td>${escapeHtml(l.details || '')}</td>
      </tr>
    `).join('') || `<tr><td colspan="4" class="muted">No logs returned.</td></tr>`);
  }

  // =============================
  // EMAIL (Admin Proxy)
  // =============================

  let emailPage = 1;
  let emailPages = 1;
  let selectedEmailId = null;

  async function loadInbox() {
    const limit = parseInt(el('emailLimit').value, 10) || 50;
    const out = await api(`/api/admin/email/inbox?page=${emailPage}&limit=${limit}`);
    const emails = out?.emails || [];
    const p = out?.pagination || {};
    emailPages = p.pages || 1;

    el('emailPagination').textContent = `Total: ${p.total ?? '—'} • Pages: ${p.pages ?? '—'}`;
    el('emailPageLabel').textContent = `Page ${p.page ?? emailPage} / ${p.pages ?? emailPages}`;

    setHtml('emailTbody', emails.map(e => `
      <tr>
        <td><button class="btn" onclick="openEmail('${e.id}')">${escapeHtml(e.id)}</button></td>
        <td>${escapeHtml(e.from_email)}</td>
        <td>${escapeHtml(e.subject)}</td>
        <td>${escapeHtml(e.received_at)}</td>
        <td>${e.read_status ? '✅' : '—'}</td>
        <td><button class="btn danger" onclick="deleteEmail('${e.id}')">Del</button></td>
      </tr>
    `).join('') || `<tr><td colspan="6" class="muted">No emails.</td></tr>`);
  }

  window.openEmail = async function(id) {
    try {
      const out = await api(`/api/admin/email/message/${encodeURIComponent(id)}`);
      const e = out?.email || out;
      selectedEmailId = e.id;

      setHtml('emailMsgMeta', `
        <div class="row">
          <span class="pill"><b>ID:</b>&nbsp;${escapeHtml(e.id)}</span>
          <span class="pill"><b>From:</b>&nbsp;${escapeHtml(e.from_email)}</span>
          <span class="pill"><b>To:</b>&nbsp;${escapeHtml(e.to_email)}</span>
        </div>
        <div class="row" style="margin-top:8px;">
          <span class="pill"><b>Subject:</b>&nbsp;${escapeHtml(e.subject)}</span>
          <span class="pill"><b>Received:</b>&nbsp;${escapeHtml(e.received_at)}</span>
        </div>
      `);

      setHtml('emailMsgBody', escapeHtml(e.body || ''));

      // Prefill reply fields
      el('sendTo').value = e.reply_to || e.from_email || '';
      el('sendSubject').value = (String(e.subject || '').startsWith('Re:') ? e.subject : `Re: ${e.subject || ''}`);
      el('replyToId').value = String(e.id || '');
      showGlobal('ok', `Opened email ${id}`);
      await loadInbox();
    } catch (e) {
      showGlobal('error', e.message);
    }
  }

  window.deleteEmail = async function(id) {
    if (!confirm(`Delete email ${id}?`)) return;
    try {
      await api(`/api/admin/email/message/${encodeURIComponent(id)}`, { method: 'DELETE' });
      showGlobal('ok', `Deleted email ${id}`);
      await loadInbox();
      if (selectedEmailId === id) {
        selectedEmailId = null;
        setHtml('emailMsgMeta', `<div class="muted">Select an email to view.</div>`);
        setHtml('emailMsgBody', ``);
      }
    } catch (e) {
      showGlobal('error', e.message);
    }
  }

  async function markRead(read) {
    if (!selectedEmailId) return showGlobal('error', 'Select an email first');
    try {
      await api(`/api/admin/email/message/${encodeURIComponent(selectedEmailId)}/read`, {
        method: 'PUT',
        body: JSON.stringify({ read })
      });
      showGlobal('ok', read ? 'Marked read' : 'Marked unread');
      await loadInbox();
    } catch (e) {
      showGlobal('error', e.message);
    }
  }

  async function sendEmail() {
    const to = el('sendTo').value.trim();
    const subject = el('sendSubject').value.trim();
    const message = el('sendMessage').value.trim();
    const replyToId = el('replyToId').value.trim() || null;

    el('emailSendMsg').innerHTML = '';
    try {
      const out = await api('/api/admin/email/send', {
        method: 'POST',
        body: JSON.stringify({ to, subject, message, replyToId })
      });
      el('emailSendMsg').innerHTML = `<div class="ok">Sent OK</div>`;
      showGlobal('ok', out?.message || 'Sent email');
      el('sendMessage').value = '';
      await loadInbox();
    } catch (e) {
      el('emailSendMsg').innerHTML = `<div class="error">${escapeHtml(e.message)}</div>`;
    }
  }

  // =============================
  // BOOT + EVENTS
  // =============================

  async function boot() {
    const token = getToken();
    el('login').classList.toggle('hidden', !!token);
    el('app').classList.toggle('hidden', !token);

    if (!token) return;

    try {
      // quick auth sanity check:
      await api('/api/admin/dashboard');
      setStatus(true, 'Admin session OK');
      await loadOverview();
    } catch (e) {
      setStatus(false, 'Session invalid — login again');
      setToken('');
      el('login').classList.remove('hidden');
      el('app').classList.add('hidden');
      showGlobal('error', e.message);
    }
  }

  // Nav clicks
  document.querySelectorAll('.nav button').forEach(btn => {
    btn.addEventListener('click', async () => {
      const view = btn.dataset.view;
      setView(view);

      try {
        if (view === 'overview') await loadOverview();
        if (view === 'users') await loadUsers();
        if (view === 'analytics') await loadAnalytics();
        if (view === 'logs') await loadLogs();
        if (view === 'email') { emailPage = 1; await loadInbox(); }
      } catch (e) {
        showGlobal('error', e.message);
      }
    });
  });

  // Buttons
  el('btnLogin').addEventListener('click', doLogin);
  el('btnClearToken').addEventListener('click', () => { setToken(''); showGlobal(null,null); });
  el('btnLogout').addEventListener('click', doLogout);

  el('btnUserLookup').addEventListener('click', lookupUser);
  el('userSearch').addEventListener('keydown', (e) => { if (e.key === 'Enter') lookupUser(); });

  el('btnRefreshUsers').addEventListener('click', () => loadUsers().catch(e => showGlobal('error', e.message)));
  el('btnRefreshAnalytics').addEventListener('click', () => loadAnalytics().catch(e => showGlobal('error', e.message)));
  el('btnRefreshLogs').addEventListener('click', () => loadLogs().catch(e => showGlobal('error', e.message)));

  el('btnEmailRefresh').addEventListener('click', () => loadInbox().catch(e => showGlobal('error', e.message)));
  el('btnEmailPrev').addEventListener('click', async () => { emailPage = Math.max(1, emailPage-1); await loadInbox(); });
  el('btnEmailNext').addEventListener('click', async () => { emailPage = Math.min(emailPages, emailPage+1); await loadInbox(); });

  el('btnSendEmail').addEventListener('click', sendEmail);
  el('btnMarkRead').addEventListener('click', () => markRead(true));
  el('btnMarkUnread').addEventListener('click', () => markRead(false));

  // Start
  (function init(){
    el('login').classList.remove('hidden');
    boot();
  })();
</script>
</body>
</html>
