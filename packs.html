<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Account &amp; Usage Dashboard - DMTools.fun</title>
    <meta name="description" content="View your plan, monthly responses, and response pack details in one account dashboard">
<link rel="stylesheet" href="/styles.css?v=20260212">
    <!-- PWA Manifest -->
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#8b5cf6">
<meta name="apple-mobile-web-app-capable" content="yes">
    
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-K0G9YRD39L"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-K0G9YRD39L');
      gtag('config', 'G-YFTZBVLQHF');
    </script>

    <!-- Lemon Squeezy -->
    <script src="https://assets.lemonsqueezy.com/lemon.js" defer></script>

   <style>
/* PAGE-SPECIFIC: Response Packs Management */
    
    /* Loading State */
    .loading {
        text-align: center;
        padding: 4rem 2rem;
        color: var(--text-secondary);
    }

/* Page Header (centered on packs page) */
    .page-header {
        text-align: center;
    }

.page-subtitle {
        font-size: 1rem;
        color: var(--text-muted);
        margin: 0 auto;
        max-width: 720px;
    }

/* Info Boxes */
    .info-box {
        background: rgba(55, 65, 81, 0.3);
        border: 1px solid var(--border-medium);
        border-radius: var(--radius-lg);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }

.info-box.success {
        background: rgba(16, 185, 129, 0.1);
        border-color: var(--success);
    }

.info-box.warning {
        background: rgba(245, 158, 11, 0.1);
        border-color: var(--warning);
    }

.info-box ul {
        margin: 1rem 0 0 0;
        padding-left: 1.5rem;
    }

.info-box li {
        margin-bottom: 0.5rem;
        color: var(--text-secondary);
    }

/* CTA Buttons Container */
    .cta-buttons {
        display: flex;
        gap: 1rem;
        margin: 1.5rem 0;
        flex-wrap: wrap;
    }

.cta-buttons .btn {
        flex: 1;
        min-width: 200px;
    }

.status-pill {
        display: inline-block;
        padding: 0.25rem 0.65rem;
        border-radius: 999px;
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: lowercase;
        border: 1px solid var(--border-medium);
    }

.status-pill.active {
        background: rgba(16, 185, 129, 0.14);
        color: #6ee7b7;
        border-color: rgba(16, 185, 129, 0.35);
    }

.status-pill.trialing {
        background: rgba(59, 130, 246, 0.16);
        color: #93c5fd;
        border-color: rgba(59, 130, 246, 0.4);
    }

.status-pill.past_due,
    .status-pill.cancelled {
        background: rgba(245, 158, 11, 0.14);
        color: #fcd34d;
        border-color: rgba(245, 158, 11, 0.4);
    }

.status-pill.inactive {
        background: rgba(107, 114, 128, 0.2);
        color: #d1d5db;
        border-color: rgba(156, 163, 175, 0.35);
    }

/* Progress Bar */
    .progress-bar {
        background: var(--bg-input);
        border-radius: var(--radius-full);
        height: 32px;
        overflow: hidden;
        position: relative;
    }

.progress-fill {
        background: linear-gradient(135deg, var(--primary), var(--accent));
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 1rem;
        transition: width 0.6s ease;
        font-weight: 550;
        font-size: 0.6rem;
    }

/* Pack Item */
    .pack-item {
        background: var(--bg-card);
        border: 2px solid var(--border-medium);
        border-radius: var(--radius-md);
        padding: 1rem;
        margin-bottom: 1rem;
        transition: border-color var(--transition-normal);
    }

.pack-item:hover {
        border-color: var(--primary);
    }

/* Responsive */
    @media (max-width: 768px) {
        .cta-buttons {
            flex-direction: column;
        }
        
        .cta-buttons .btn {
            width: 100%;
        }
        
        .footer-grid {
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }
    }
</style>
</head>
<body>
   <header class="header">
    <div class="nav-container">
        <a href="/" class="logo">DMTools.fun</a>
        <div class="auth-buttons" id="authButtons">
            <button class="mobile-menu-btn" onclick="toggleMobileMenu()" aria-label="Menu">‚ò∞</button>
        <button data-auth="login">Sign In</button>
          <button data-auth="register">Sign Up</button>

        </div>
    </div>
    
    <nav class="mobile-nav" id="mobileNav">
        <a href="/app.html" class="tab-btn">Generator</a>
        <a href="/presets.html" class="tab-btn">Templates</a>
        <a href="/packs.html" class="tab-btn">Response Packs</a>
        <a href="/pricing.html" class="tab-btn">Pricing</a>
        <a href="/store.html" class="tab-btn">Packs Store</a>
</nav>
</header>
    <!-- END HEADER WITH NAVIGATION -->
    
    <div class="container">
        <div class="page-header">
            <h2 class="page-title">Account &amp; Usage Dashboard</h2>
            <p class="page-subtitle">View your plan, monthly responses, and response packs in one place</p>
        </div>
        
        <!-- Loading State -->
        <div id="loading" class="loading">
            <div style="font-size: 3rem; margin-bottom: 1rem;">‚è≥</div>
            <p>Loading your account...</p>
        </div>
        
        <!-- Main Content (Hidden until loaded) -->
        <div id="content" class="hidden">

            <div id="plan-usage-section" class="hidden" style="display:none;">
                <div class="card">
                    <h2>Plan &amp; Usage</h2>
                    <div class="info-box">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 1rem;">
                            <div>
                                <p style="margin: 0 0 0.5rem 0;"><strong>Plan:</strong> <span id="dashboard-plan-label">Loading...</span></p>
                                <p style="margin: 0;"><strong>Status:</strong> <span id="dashboard-status-badge" class="status-pill inactive">inactive</span></p>
                            </div>
                            <div style="min-width: 220px;">
                                <p style="margin: 0 0 0.5rem 0;"><strong>Monthly allowance:</strong> <span id="dashboard-monthly-allowance">Loading...</span></p>
                                <p style="margin: 0;"><strong>Responses remaining:</strong> <span id="dashboard-responses-remaining">Loading...</span></p>
                            </div>
                        </div>
                        <p id="dashboard-free-reminder" style="margin: 1rem 0 0 0; color: var(--text-secondary); display:none;">
                            10 responses/month for life (no card required)
                        </p>
                        <p id="dashboard-status-note" style="margin: 1rem 0 0 0; color: var(--text-secondary);"></p>
                        <div class="cta-buttons" style="margin-bottom: 0;" id="dashboard-cta-buttons">
                            <a id="dashboard-primary-cta" href="/pricing.html" class="btn btn-primary">View plans</a>
                            <a id="dashboard-secondary-cta" href="/pricing.html#packs" class="btn btn-secondary">Buy packs</a>
                        </div>
                        <div class="info-box" style="margin-top: 1rem; margin-bottom: 0;">
                            <p style="margin: 0 0 0.5rem 0;"><strong>Missing a purchase?</strong></p>
                            <p style="margin: 0 0 0.75rem 0; color: var(--text-secondary);">
                                If checkout used a different email, claim purchases here.
                            </p>
                            <div style="display: flex; gap: 0.75rem; flex-wrap: wrap; align-items: center;">
                                <input
                                    id="claim-email"
                                    type="email"
                                    placeholder="Checkout email"
                                    style="flex: 1; min-width: 220px; background: var(--bg-input); border: 1px solid var(--border-medium); border-radius: var(--radius-md); color: var(--text-primary); padding: 0.65rem 0.75rem;"
                                />
                                <button id="claim-purchases-btn" type="button" class="btn btn-secondary" onclick="handleClaimPurchases()">
                                    Claim purchases
                                </button>
                            </div>
                            <p id="claim-purchases-error" style="margin: 0.65rem 0 0 0; color: var(--error); display: none;"></p>
                            <p id="claim-purchases-result" style="margin: 0.65rem 0 0 0; color: var(--text-secondary); display: none;"></p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="pack-details-section" class="hidden" style="display:none;">
                <div class="card">
                    <h2>Pack Details</h2>
                    <div class="info-box">
                        <p style="margin-top: 0;"><strong>Pack balance:</strong> <span id="pack-balance">0 responses</span></p>
                        <div id="pack-details-content">
                            <p style="color: var(--text-secondary); margin-bottom: 0;">Loading pack details...</p>
                        </div>
                    </div>
                </div>
            </div>
             
            <!-- Free User Section -->
            <div id="free-section" class="hidden">
                <div class="card">
                    <h2>Get Started with Response Packs</h2>
                    
                    <div class="info-box">
                        <p><strong>How THE-RIGHT-CLICK SIDE-KICK works:</strong></p>
                        <ul>
                            <li>üì• Download the Chrome extension</li>
                            <li>Sign up for a free account and get 10 responses/month free</li>
                            <li>üí≥ Buy response packs ($9.99-$34.99)</li>
                            <li>‚ú® Generate AI replies instantly</li>
                            <li>üéØ Works anywhere, if you can type a response to send, so can the RIGHT-CLICK SIDEKICK!</li>
                        </ul>
                    </div>
                    
                    <div class="cta-buttons">
                        <a href="/pricing.html" class="btn btn-primary">
                            üõí Buy Response Packs
                        </a>
                    </div>
                    
                    <div class="info-box">
                        <p>üí° <strong>Want monthly responses instead?</strong></p>
                        <p><a href="/pricing.html" style="color: var(--primary); font-weight: 600;">View subscription plans</a> subscribe now to take advantage of monthly responses</p>
                    </div>
                </div>
            </div>
            
            <!-- Subscriber Section (Pro/Business) -->
            <div id="subscriber-section" class="hidden" style="display:none;">
                <div class="card">
                    <h2>üìä Your Subscription</h2>
                    
                    <div class="info-box success">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                            <div>
                                <div style="font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem;">
                                    <span id="plan-name">-</span> Plan
                                </div>
                                <div style="color: var(--text-secondary);">
                                    <span id="monthly-limit">-</span> responses/month
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 2rem; font-weight: 800; color: var(--secondary);">
                                    <span id="responses-remaining">-</span>
                                </div>
                                <div style="color: var(--text-secondary); font-size: 0.9rem;">remaining</div>
                            </div>
                        </div>
                        
                        <div class="progress-bar" style="margin-top: 1rem;">
                            <div class="progress-fill" id="usage-bar" style="width: 0%;">
                                <span id="usage-text">Loading...</span>
                                <span id="usage-percent">0%</span>
                            </div>
                        </div>
                        <small style="color: var(--text-secondary); display: block; margin-top: 0.5rem;">
                            Shared between batch generator and THE-RIGHT-CLICK SIDEKICK extension
                        </small>
                    </div>
                    
                                  
                    <div class="info-box" style="margin-top: 2rem;">
                        <p>üí° <strong>Want backup responses?</strong></p>
                        <p><a href="/store.html" style="color: var(--primary); font-weight: 600;">Buy response packs</a> to ADD to your monthly allowance</p>
                        <small style="color: var(--text-secondary); display: block; margin-top: 0.5rem;">
                            Example: Pro (2,000) + 500 pack = 2,500 total shared pool
                        </small>
                    </div>
                </div>
            </div>
            
            <!-- Enterprise Section -->
         <div class="hidden" id="enterprise-section" style="display:none;">
                <div class="card">
                    <h2>üöÄ Unlimited Extension Access</h2>
                    
                    <div class="info-box warning">
                        <div style="text-align: center; font-size: 1.5rem; font-weight: 700; margin-bottom: 1rem;">
                            ‚ôæÔ∏è Your Enterprise plan includes unlimited RIGHT-CLICK SIDEKICK access
                        </div>
                    </div>
                    
                    <div class="info-box success">
                        <p><strong>Enterprise Benefits:</strong></p>
                        <ul>
                            <li>‚úì Unlimited RIGHT-CLICK SIDE-KICK extension responses</li>
                            <li>‚úì 25,000 batch generator responses/month</li>
                            <li>‚úì Truly unlimited inline AI response generation that works everywhere on the internet</li>
                        </ul>
                    </div>
                    
                  
                </div>
            </div>
            
        </div>
    </div>
    
   <!-- FOOTER -->
<footer class="footer">
    <div class="container">
        <div class="footer-content">
            <div class="footer-brand">
                <h3 class="footer-logo">DMTools.fun</h3>
                <p class="footer-description">
                    AI-powered universal messaging response generator.<br>
                    "With Two right-clicks You Wont go wrong‚Ñ¢"
                </p>
            </div>
            
            <div class="footer-links">
                <div class="link-group">
                    <h4>Product</h4>
                    <a href="/app.html">Batch Generator</a>
                    <a href="/presets.html">Templates</a>
                    <a href="/pricing.html">Pricing</a>
                    <a href="/store.html">Packs Store</a>
</div>
                
                <div class="link-group">
                    <h4>Legal</h4>
                    <a href="/terms-of-service.html">Terms of Service</a>
                    <a href="/privacy-policy.html">Privacy Policy</a>
                    <a href="/refund-policy.html">Refund Policy</a>
                    <a href="/cookie-policy.html">Cookie Policy</a>
                </div>
                
                <div class="link-group">
                    <h4>Support</h4>
                    <a href="/contact.html">Contact Us</a>
                    <a href="mailto:support@dmtools.fun">Email Support</a>
                </div>
            </div>
        </div>
        
        <div class="footer-bottom">
            <p class="footer-copyright">¬© 2025 DMTools.fun LLC. All rights reserved.</p>
        </div>
    </div>
</footer>
<!-- END FOOTER -->
    
   <script>
    const API_BASE = 'https://dmtools-backend-production.up.railway.app/api';

    function toggleMobileMenu() {
        document.getElementById('mobileNav').classList.toggle('show');
    }

    function handleLogout() {
        localStorage.removeItem('authToken');
        window.location.href = '/';
    }

    function toNumber(value) {
        const num = Number(value);
        return Number.isFinite(num) ? num : null;
    }

    function formatNumber(value) {
        const num = toNumber(value);
        return num === null ? '-' : num.toLocaleString();
    }

    function formatTierLabel(tier) {
        return String(tier || '')
            .replace(/[_-]+/g, ' ')
            .replace(/\b\w/g, (match) => match.toUpperCase());
    }

    function normalizeStatus(rawStatus) {
        const normalized = String(rawStatus || '').toLowerCase().trim();
        const supported = ['active', 'trialing', 'past_due', 'cancelled', 'inactive'];
        return supported.includes(normalized) ? normalized : 'inactive';
    }

    function isValidEmail(email) {
        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(email || '').trim());
    }

    function setClaimPurchasesMessage(text, isError) {
        const errorEl = document.getElementById('claim-purchases-error');
        const resultEl = document.getElementById('claim-purchases-result');
        if (!errorEl || !resultEl) return;

        if (isError) {
            errorEl.textContent = text;
            errorEl.style.display = 'block';
            resultEl.style.display = 'none';
            resultEl.textContent = '';
            return;
        }

        resultEl.textContent = text;
        resultEl.style.display = text ? 'block' : 'none';
        resultEl.style.color = text && text.toLowerCase().startsWith('claimed')
            ? 'var(--success)'
            : 'var(--text-secondary)';
        errorEl.style.display = 'none';
        errorEl.textContent = '';
    }

    function initializeClaimPurchases(user) {
        const input = document.getElementById('claim-email');
        if (!input) return;
        if (!input.value && user && user.email) {
            input.value = String(user.email).trim();
        }
    }

    async function handleClaimPurchases() {
        const token = localStorage.getItem('authToken');
        const emailInput = document.getElementById('claim-email');
        const button = document.getElementById('claim-purchases-btn');
        if (!token || !emailInput || !button) return;

        const email = String(emailInput.value || '').trim().toLowerCase();
        setClaimPurchasesMessage('', false);

        if (!isValidEmail(email)) {
            setClaimPurchasesMessage('Enter a valid email address.', true);
            return;
        }

        const originalButtonText = button.textContent;
        button.disabled = true;
        button.textContent = 'Claiming...';

        try {
            const response = await fetch(API_BASE + '/subscription/claim-purchases', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ email })
            });

            if (response.status === 400) {
                setClaimPurchasesMessage('Enter a valid email address.', true);
                return;
            }

            if (response.status === 401 || response.status === 403) {
                setClaimPurchasesMessage('Session expired. Please sign in again.', true);
                return;
            }

            if (!response.ok) {
                setClaimPurchasesMessage('Could not claim purchases right now. Please try again.', true);
                return;
            }

            const data = await response.json();
            const claimedCount = Number(data.claimed_count) || 0;

            if (claimedCount > 0) {
                await loadPage();
                setClaimPurchasesMessage(`Claimed ${claimedCount} purchase(s).`, false);
            } else {
                setClaimPurchasesMessage('No purchases found to claim.', false);
            }
        } catch (error) {
            console.error('Claim purchases request failed:', error);
            setClaimPurchasesMessage('Could not claim purchases right now. Please try again.', true);
        } finally {
            button.disabled = false;
            button.textContent = originalButtonText;
        }
    }

    function getDefaultMonthlyLimit(tier) {
        const map = {
            free: 10,
            pro: 2000,
            business: 8000,
            enterprise: 25000
        };
        return map[String(tier || '').toLowerCase()] ?? null;
    }

    function setSectionVisibility(sectionEl, isVisible) {
        if (!sectionEl) return;
        sectionEl.style.display = isVisible ? 'block' : 'none';
        sectionEl.classList.toggle('hidden', !isVisible);
    }

    function setDashboardCtas(primaryText, primaryHref, secondaryText, secondaryHref) {
        const primary = document.getElementById('dashboard-primary-cta');
        const secondary = document.getElementById('dashboard-secondary-cta');
        if (!primary || !secondary) return;

        primary.textContent = primaryText;
        primary.href = primaryHref;

        secondary.textContent = secondaryText;
        secondary.href = secondaryHref;
        secondary.style.display = secondaryText ? 'inline-flex' : 'none';
    }

    function updateSubscriberSection(user, tier) {
        const planNameEl = document.getElementById('plan-name');
        const monthlyLimitEl = document.getElementById('monthly-limit');
        const responsesRemainingEl = document.getElementById('responses-remaining');
        const usageBarEl = document.getElementById('usage-bar');
        const usageTextEl = document.getElementById('usage-text');
        const usagePercentEl = document.getElementById('usage-percent');

        let monthlyLimit = toNumber(user.monthly_limit);
        if (monthlyLimit === null) {
            monthlyLimit = getDefaultMonthlyLimit(tier);
        }

        let responsesRemaining = toNumber(user.responses_remaining);
        if (responsesRemaining === null && monthlyLimit !== null) {
            const monthlyUsage = toNumber(user.monthly_usage) ?? 0;
            responsesRemaining = Math.max(0, monthlyLimit - monthlyUsage);
        }

        const used = (monthlyLimit !== null && responsesRemaining !== null)
            ? Math.max(0, monthlyLimit - responsesRemaining)
            : (toNumber(user.monthly_usage) ?? 0);
        const percent = monthlyLimit && monthlyLimit > 0
            ? Math.max(0, Math.min(100, Math.round((used / monthlyLimit) * 100)))
            : 0;

        planNameEl.textContent = formatTierLabel(tier);
        monthlyLimitEl.textContent = monthlyLimit === null ? '-' : formatNumber(monthlyLimit);
        responsesRemainingEl.textContent = responsesRemaining === null ? '-' : formatNumber(responsesRemaining);
        usageBarEl.style.width = percent + '%';
        usageTextEl.textContent = formatNumber(used) + ' used';
        usagePercentEl.textContent = percent + '%';
    }

    function renderPlanUsageSection(user, tier, status, isActive) {
        const planUsageSection = document.getElementById('plan-usage-section');
        const planLabelEl = document.getElementById('dashboard-plan-label');
        const statusBadgeEl = document.getElementById('dashboard-status-badge');
        const monthlyAllowanceEl = document.getElementById('dashboard-monthly-allowance');
        const responsesRemainingEl = document.getElementById('dashboard-responses-remaining');
        const reminderEl = document.getElementById('dashboard-free-reminder');
        const noteEl = document.getElementById('dashboard-status-note');

        let monthlyLimit = toNumber(user.monthly_limit);
        if (monthlyLimit === null && (isActive || tier === 'free' || !tier)) {
            monthlyLimit = getDefaultMonthlyLimit(tier || 'free');
        }

        let responsesRemaining = toNumber(user.responses_remaining);
        if (responsesRemaining === null && monthlyLimit !== null) {
            const monthlyUsage = toNumber(user.monthly_usage);
            if (monthlyUsage !== null) {
                responsesRemaining = Math.max(0, monthlyLimit - monthlyUsage);
            }
        }

        const manageUrl = user.customer_portal_url
            || user.manage_subscription_url
            || user.billing_portal_url
            || '';

        let planLabel = 'Free';
        let statusNote = '';

        if (isActive && tier === 'enterprise') {
            planLabel = 'Enterprise';
            statusNote = 'Enterprise responses are active across the dashboard and extension.';
            if (manageUrl) {
                setDashboardCtas('Manage subscription', manageUrl, 'Buy packs', '/pricing.html#packs');
            } else {
                setDashboardCtas('View plans', '/pricing.html', 'Buy packs', '/pricing.html#packs');
            }
        } else if (isActive && (tier === 'pro' || tier === 'business')) {
            planLabel = 'Subscription: ' + formatTierLabel(tier);
            statusNote = 'Monthly responses are active and shared between batch and extension usage.';
            if (manageUrl) {
                setDashboardCtas('Manage subscription', manageUrl, 'Buy packs', '/pricing.html#packs');
            } else {
                setDashboardCtas('View plans', '/pricing.html', 'Buy packs', '/pricing.html#packs');
            }
        } else if (status === 'past_due' || status === 'cancelled') {
            planLabel = tier && tier !== 'free' ? 'No active subscription' : 'Free';
            statusNote = 'Your subscription is not active. Fix billing to restore monthly responses.';
            setDashboardCtas('Fix billing', '/pricing.html', 'Buy packs', '/pricing.html#packs');
        } else if (tier && tier !== 'free') {
            planLabel = 'No active subscription';
            statusNote = 'You do not have an active subscription. Upgrade or buy packs to continue.';
            setDashboardCtas('Upgrade', '/pricing.html', 'Buy packs', '/pricing.html#packs');
        } else {
            planLabel = 'Free';
            statusNote = 'Use your free monthly responses and top up anytime with packs.';
            setDashboardCtas('Upgrade', '/pricing.html', 'Buy packs', '/pricing.html#packs');
        }

        planLabelEl.textContent = planLabel;
        statusBadgeEl.textContent = status;
        statusBadgeEl.className = 'status-pill ' + status;
        monthlyAllowanceEl.textContent = monthlyLimit === null
            ? 'Not available'
            : formatNumber(monthlyLimit) + ' responses/month';
        responsesRemainingEl.textContent = responsesRemaining === null
            ? 'Not available'
            : formatNumber(responsesRemaining) + ' responses';
        reminderEl.style.display = isActive ? 'none' : 'block';
        noteEl.textContent = statusNote;

        setSectionVisibility(planUsageSection, true);
    }

    function escapeHtml(text) {
        return String(text)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/\"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }

    function getPackItems(user) {
        if (Array.isArray(user.packs)) return user.packs;
        if (Array.isArray(user.response_packs)) return user.response_packs;
        if (Array.isArray(user.pack_details)) return user.pack_details;
        return [];
    }

    function getPackBalance(user, packItems) {
        const candidateKeys = [
            'pack_balance',
            'response_pack_balance',
            'pack_responses_remaining',
            'packs_remaining',
            'response_packs_remaining'
        ];

        for (const key of candidateKeys) {
            const value = toNumber(user[key]);
            if (value !== null) return value;
        }

        if (packItems.length > 0) {
            const summed = packItems.reduce((total, item) => {
                const remaining = toNumber(item.responses_remaining)
                    ?? toNumber(item.remaining)
                    ?? toNumber(item.balance);
                return total + (remaining ?? 0);
            }, 0);
            return summed;
        }

        return 0;
    }

    function renderPackDetailsSection(user) {
        const sectionEl = document.getElementById('pack-details-section');
        const balanceEl = document.getElementById('pack-balance');
        const contentEl = document.getElementById('pack-details-content');

        const packItems = getPackItems(user);
        const packBalance = getPackBalance(user, packItems);

        balanceEl.textContent = formatNumber(packBalance) + ' responses';

        if (!packItems.length) {
            contentEl.innerHTML = '<p style="color: var(--text-secondary); margin-bottom: 0;">No packs found. Buy a pack to top up your replies.</p>';
            setSectionVisibility(sectionEl, true);
            return;
        }

        contentEl.innerHTML = packItems.map((item) => {
            const packName = item.pack_name || item.name || 'Response pack';
            const remaining = toNumber(item.responses_remaining)
                ?? toNumber(item.remaining)
                ?? toNumber(item.balance);
            const status = String(item.status || 'active').toLowerCase();
            const expiration = item.expiration_date || item.expires_at || item.expiry_date;
            const expirationText = expiration
                ? new Date(expiration).toLocaleDateString()
                : 'No expiration';

            return `
                <div class="pack-item">
                    <p style="margin: 0 0 0.4rem 0;"><strong>${escapeHtml(packName)}</strong></p>
                    <p style="margin: 0; color: var(--text-secondary);">
                        ${remaining === null ? 'Balance not available' : (formatNumber(remaining) + ' responses remaining')}
                    </p>
                    <small style="display: block; margin-top: 0.35rem; color: var(--text-secondary);">
                        Status: ${escapeHtml(status)} | Expires: ${escapeHtml(expirationText)}
                    </small>
                </div>
            `;
        }).join('');

        setSectionVisibility(sectionEl, true);
    }

    async function updateAuthSection() {
        const token = localStorage.getItem('authToken');
        const authButtons = document.getElementById('authButtons');

        if (!authButtons) return;

        if (!token) {
            authButtons.innerHTML = `
                <button class="mobile-menu-btn" onclick="toggleMobileMenu()" aria-label="Menu">‚ò∞</button>
                <a href="#" data-auth="login" class="btn btn-secondary">Sign In</a>
                <a href="#" data-auth="register" class="btn btn-primary">Sign Up</a>
            `;
            return;
        }

        try {
            const response = await fetch(API_BASE + '/user/profile', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (!response.ok) {
                localStorage.removeItem('authToken');
                updateAuthSection();
                return;
            }

            const data = await response.json();
            const user = data.user;

            authButtons.innerHTML = `
                <button class="mobile-menu-btn" onclick="toggleMobileMenu()" aria-label="Menu">‚ò∞</button>
                <span class="user-email">${user.email}</span>
                <button class="btn btn-secondary" onclick="handleLogout()">Logout</button>
            `;
        } catch (error) {
            console.error('Auth check failed:', error);
            authButtons.innerHTML = `
                <button class="mobile-menu-btn" onclick="toggleMobileMenu()" aria-label="Menu">‚ò∞</button>
                <a href="#" data-auth="login" class="btn btn-secondary">Sign In</a>
                <a href="#" data-auth="register" class="btn btn-primary">Sign Up</a>
            `;
        }
    }

    async function loadPage() {
        const token = localStorage.getItem('authToken');
        const loading = document.getElementById('loading');
        const content = document.getElementById('content');
        const freeSection = document.getElementById('free-section');
        const subscriberSection = document.getElementById('subscriber-section');
        const enterpriseSection = document.getElementById('enterprise-section');
        const planUsageSection = document.getElementById('plan-usage-section');
        const packDetailsSection = document.getElementById('pack-details-section');

        setSectionVisibility(planUsageSection, false);
        setSectionVisibility(packDetailsSection, false);
        setSectionVisibility(freeSection, false);
        setSectionVisibility(subscriberSection, false);
        setSectionVisibility(enterpriseSection, false);

        if (!token) {
            loading.classList.add('hidden');
            content.classList.remove('hidden');
            setSectionVisibility(freeSection, true);
            return;
        }

        try {
            const response = await fetch(API_BASE + '/user/profile', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (!response.ok) {
                if (response.status === 401) {
                    localStorage.removeItem('authToken');
                    loading.classList.add('hidden');
                    content.classList.remove('hidden');
                    setSectionVisibility(freeSection, true);
                    return;
                }
                throw new Error('Failed to fetch user data');
            }

            const data = await response.json();
            const user = data.user || {};

            loading.classList.add('hidden');
            content.classList.remove('hidden');

            initializeClaimPurchases(user);

            const tier = String(user.subscription_tier || '').toLowerCase().trim();
            const status = normalizeStatus(user.subscription_status);
            const isActive = status === 'active' || status === 'trialing';

            renderPlanUsageSection(user, tier, status, isActive);
            renderPackDetailsSection(user);

            if (isActive && tier === 'enterprise') {
                setSectionVisibility(enterpriseSection, true);
            } else if (isActive && (tier === 'pro' || tier === 'business')) {
                updateSubscriberSection(user, tier);
                setSectionVisibility(subscriberSection, true);
            } else {
                setSectionVisibility(freeSection, true);
            }
        } catch (error) {
            console.error('Error loading page:', error);
            loading.innerHTML = `
                <div style="color: var(--error); max-width: 500px; margin: 0 auto;">
                    <h2 style="margin-bottom: 1rem;">‚ö†Ô∏è Error Loading Page</h2>
                    <p style="margin-bottom: 1rem;">Could not load your account data. Please try again.</p>
                    <button onclick="location.reload()" class="btn btn-primary">Retry</button>
                    <a href="/app.html" class="btn btn-secondary" style="margin-left: 1rem;">Back to App</a>
                </div>
            `;
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        updateAuthSection();
        loadPage();
    });
</script>
<script src="js/app-core.js"></script>
<script src="js/auth-modal.js"></script>
</body>
</html>

