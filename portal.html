<!DOCTYPE html>
<html lang="en">
<head>
  <!-- ===========================================================
       DMTools Portal (Clean + Correct Messaging)
       CURRENT TRUTH (matches your system today):
         - Subscriptions unlock Pro Features AND include monthly responses.
         - Response Packs add extra responses for subscribers,
           OR unlock core reply generation for non-subscribers.
       =========================================================== -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DMTools Portal</title>
  <meta name="description" content="DMTools portal: core tools (responses) + pro features (subscription)." />

  <!-- Your existing site styling -->
  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="/css/styles.css" />

  <style>
    /* Minimal page-specific styles ONLY */
    .portal-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-top: 16px;
    }
    @media (max-width: 980px){
      .portal-grid { grid-template-columns: 1fr; }
    }
    .portal-meta {
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top: 12px;
      align-items:center;
    }
    .pill {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      opacity: .95;
    }
    .pill.good{ border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.10); }
    .pill.warn{ border-color: rgba(245,158,11,.35); background: rgba(245,158,11,.10); }
    .pill.bad{ border-color: rgba(239,68,68,.35); background: rgba(239,68,68,.10); }

    .portal-actions {
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top: 14px;
    }
    .muted { opacity: .82; line-height: 1.5; }
    .locked { opacity: .58; filter: saturate(.9); }

    /* Toast */
    .toast {
      position: fixed;
      top: 16px;
      right: 16px;
      width: min(420px, calc(100% - 32px));
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(10,10,18,.92);
      border-radius: 16px;
      padding: 12px 14px;
      box-shadow: 0 18px 55px rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
      opacity: 0;
      transform: translateY(-10px);
      transition: opacity .18s ease, transform .18s ease;
      z-index: 9999;
      pointer-events: none;
    }
    .toast.show{ opacity: 1; transform: translateY(0); }
    .toast strong{ display:block; margin-bottom: 2px; font-size: 13px; }
    .toast span{ opacity: .88; font-size: 12.5px; line-height: 1.35; display:block; }
  </style>
</head>

<body>
  <!-- ===========================================================
       Header/Nav (matches app.html-style structure)
       =========================================================== -->
  <header class="header">
    <div class="nav-container">
      <a class="logo" href="/">DMTools.fun</a>

      <div class="auth-buttons" id="authButtons">
        <button aria-label="Menu" class="mobile-menu-btn" onclick="toggleMobileMenu()">☰</button>

        <div class="auth-buttons" id="user-section">
          <span class="user-email" id="user-email"></span>
          <button class="btn btn-secondary" id="btnLogout">Logout</button>
        </div>
      </div>
    </div>

    <nav class="mobile-nav" id="mobileNav">
      <a class="tab-btn" href="/app.html">Generator</a>
      <a class="tab-btn" href="/presets.html">Templates</a>
      <a class="tab-btn" href="/analytics.html">Analytics</a>
      <a class="tab-btn" href="/packs.html">Response Packs</a>
      <a class="tab-btn" href="/pricing.html">Pricing</a>
      <a class="tab-btn" href="/store.html">Store</a>
      <a class="tab-btn" href="/account.html">Account</a>
      <a class="tab-btn active" href="/portal.html">Portal</a>
    </nav>
  </header>

  <!-- ===========================================================
       Main
       =========================================================== -->
  <main class="container" style="padding-top: 18px;">
    <div class="card">
      <h1 style="margin-top:0;">Portal</h1>
      <p class="muted" style="margin-bottom:0;">
        <b>Subscriptions</b> unlock Pro Features and include monthly responses.
        <br />
        <b>Response Packs</b> add extra responses — or unlock core reply generation without a subscription.
      </p>
      <p class="muted" style="margin:10px 0 0;">
        In short: responses are deducted from your <b>subscription allowance</b> first (if active), otherwise from your <b>packs</b>.
      </p>
    </div>

    <div class="portal-grid">
      <!-- CORE -->
      <section class="card" id="coreCard">
        <h2 style="margin-top:0;">Core Tools (Reply Generation)</h2>
        <p class="muted">
          Generate replies anywhere using the extension and batch tools.
          Responses are deducted from your subscription allowance or response packs.
        </p>

        <ul class="muted" style="line-height:1.6; margin-top:10px;">
          <li>Extension reply generation</li>
          <li>Batch generation</li>
          <li>Account + billing management</li>
        </ul>

        <div class="portal-meta">
          <span class="pill" id="pillCredits">Pack credits: …</span>
          <span class="pill" id="pillFree">Free this month: …</span>
        </div>

        <div class="portal-actions">
          <a class="btn btn-primary" href="/app.html">Open Core Tools</a>
          <a class="btn btn-secondary" href="/packs.html">Buy Response Packs</a>
          <a class="btn btn-secondary" href="/install-extension.html">Install / Open Extension</a>
          <a class="btn btn-secondary" href="/account.html">Account</a>
        </div>
      </section>

      <!-- PRO -->
      <section class="card" id="proCard">
        <h2 style="margin-top:0;">Pro Features (Subscription)</h2>
        <p class="muted">
          Customize your voice and unlock insights. Subscribers receive monthly responses; packs can be added for extra usage.
        </p>

        <ul class="muted" style="line-height:1.6; margin-top:10px;">
          <li>Tone + context settings</li>
          <li>Custom presets / templates</li>
          <li>Analytics pages</li>
        </ul>

        <div class="portal-meta">
          <span class="pill" id="pillSub">Subscription: …</span>
          <span class="pill" id="pillPlan">Plan: …</span>
        </div>

        <div class="portal-actions" id="proButtons">
          <a class="btn btn-primary" href="/presets.html">Open Tone / Presets</a>
          <a class="btn btn-secondary" href="/analytics.html">Open Analytics</a>
          <a class="btn btn-secondary" href="/pricing.html">Manage Subscription</a>
        </div>
      </section>
    </div>

    <div class="card" style="margin-top:16px;">
      <p class="muted" style="margin:0;">
        Tip: If you run out of subscription responses, you can add response packs to keep generating — even without upgrading your plan.
      </p>
    </div>
  </main>

  <!-- Toast -->
  <div class="toast" id="toast" aria-live="polite" aria-atomic="true">
    <strong id="toastTitle">Loading…</strong>
    <span id="toastMsg">Checking your access.</span>
  </div>

  <script>
    // ===========================================================
    // Mobile menu (matches app.html pattern)
    // ===========================================================
    function toggleMobileMenu() {
      const nav = document.getElementById('mobileNav');
      if (!nav) return;
      nav.classList.toggle('open');
    }

    // ===========================================================
    // Portal logic (Phase 1 behavior)
    // - Reads existing backend status endpoints to display state
    // - Does not change billing logic
    // ===========================================================
    const API_BASE = 'https://dmtools-backend-production.up.railway.app/api';
    const TOKEN_KEY = 'authToken';

    const btnLogout = document.getElementById('btnLogout');
    const userEmailEl = document.getElementById('user-email');

    const pillCredits = document.getElementById('pillCredits');
    const pillFree = document.getElementById('pillFree');
    const pillSub = document.getElementById('pillSub');
    const pillPlan = document.getElementById('pillPlan');

    const proCard = document.getElementById('proCard');
    const proButtons = document.getElementById('proButtons');

    const toast = document.getElementById('toast');
    const toastTitle = document.getElementById('toastTitle');
    const toastMsg = document.getElementById('toastMsg');

    let toastTimer = null;
    function showToast(title, msg, ms = 2600) {
      toastTitle.textContent = title;
      toastMsg.textContent = msg;
      toast.classList.add('show');
      if (toastTimer) clearTimeout(toastTimer);
      toastTimer = setTimeout(() => toast.classList.remove('show'), ms);
    }

    function getToken() { return localStorage.getItem(TOKEN_KEY); }

    function requireAuth() {
      const token = getToken();
      if (!token) {
        const returnTo = encodeURIComponent('/portal.html');
        window.location.href = `/login.html?returnTo=${returnTo}`;
        return false;
      }
      return true;
    }

    function logout() {
      localStorage.removeItem(TOKEN_KEY);
      window.location.href = '/login.html';
    }

    async function apiCall(path, opts = {}) {
      const token = getToken();
      const res = await fetch(`${API_BASE}${path}`, {
        ...opts,
        headers: {
          'Content-Type': 'application/json',
          ...(token ? { 'Authorization': `Bearer ${token}` } : {}),
          ...(opts.headers || {})
        }
      });

      const text = await res.text();
      let data = null;
      try { data = JSON.parse(text); } catch (e) { data = { raw: text }; }

      if (!res.ok) {
        const msg = (data && (data.error || data.message)) ? (data.error || data.message) : `HTTP ${res.status}`;
        throw new Error(msg);
      }
      return data;
    }

    function setPill(el, text, kind = null) {
      el.classList.remove('good', 'warn', 'bad');
      if (kind) el.classList.add(kind);
      el.textContent = text;
    }

    function computeFreeRemaining(subResp) {
      const sub = subResp?.subscription || {};
      const plan = (sub.plan || 'free').toLowerCase();

      // Show free monthly allowance only if plan is free (your current free policy)
      if (plan !== 'free') return null;

      const used = Number(sub.monthly_usage || 0);
      const FREE_LIMIT = 10;
      return Math.max(0, FREE_LIMIT - used);
    }

    function setProLocked(locked) {
      if (locked) {
        proCard.classList.add('locked');
        proButtons.innerHTML = `
          <a class="btn btn-primary" href="/pricing.html">Unlock Pro Features (Subscribe)</a>
          <a class="btn btn-secondary" href="/packs.html">Buy Response Packs</a>
        `;
      } else {
        proCard.classList.remove('locked');
        proButtons.innerHTML = `
          <a class="btn btn-primary" href="/presets.html">Open Tone / Presets</a>
          <a class="btn btn-secondary" href="/analytics.html">Open Analytics</a>
          <a class="btn btn-secondary" href="/pricing.html">Manage Subscription</a>
        `;
      }
    }

    async function loadPortal() {
      showToast('Loading…', 'Checking your access.');

      const [subResp, packResp, profileResp] = await Promise.all([
        apiCall('/subscription/status'),
        apiCall('/packs/status'),
        apiCall('/user/profile')
      ]);

      // Header email
      const email = profileResp?.user?.email || '';
      if (email) userEmailEl.textContent = email;

      // Subscription state
      const sub = subResp?.subscription || {};
      const plan = (sub.plan || 'free');
      const subStatus = (sub.status || 'none').toLowerCase();
      const hasSubscription = (subStatus === 'active');

      setPill(pillPlan, `Plan: ${plan}`);
      setPill(pillSub, `Subscription: ${hasSubscription ? 'Active' : 'Not Active'}`, hasSubscription ? 'good' : 'warn');

      // Pack credits state
      const credits = Number(packResp?.credits_remaining || 0);
      setPill(pillCredits, `Pack credits: ${credits}`, credits > 0 ? 'good' : 'bad');

      // Free allowance (only if free plan)
      const freeRemaining = computeFreeRemaining(subResp);
      if (freeRemaining === null) {
        setPill(pillFree, 'Free this month: —');
      } else {
        const kind = freeRemaining >= 6 ? 'good' : (freeRemaining >= 1 ? 'warn' : 'bad');
        setPill(pillFree, `Free this month: ${freeRemaining}`, kind);
      }

      // Pro gating
      setProLocked(!hasSubscription);

      // Toast summary
      if (hasSubscription) {
        showToast('Ready ✅', 'Subscription active. Packs can extend usage if you run out of monthly responses.');
      } else {
        showToast('Ready ✅', 'No subscription. Use packs (or free monthly allowance) for core reply generation.');
      }
    }

    btnLogout.addEventListener('click', logout);

    (function init() {
      if (!requireAuth()) return;
      loadPortal().catch((err) => {
        console.error('Portal load failed:', err);
        showToast('Error', err?.message || 'Failed to load access.', 5200);
      });
    })();
  </script>
</body>
</html>
