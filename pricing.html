    <!DOCTYPE html>
        <html lang="en">
    <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Pricing Plans - DMTools.fun</title>
            <meta name="description" content="Choose the perfect plan for your messaging needs. From free to enterprise, we've got you covered.">

            <!-- PWA Manifest -->
            <link rel="manifest" href="/manifest.json">
            <meta name="theme-color" content="#8b5cf6">
            <meta name="mobile-web-app-capable" content="yes">
            <meta name="apple-mobile-web-app-capable" content="yes">

            <link rel="stylesheet" href="/styles.css?v=20260212">
    
     <!-- Google Analytics -->
            <script async src="https://www.googletagmanager.com/gtag/js?id=G-K0G9YRD39L"></script>
            <script>
                   window.dataLayer = window.dataLayer || [];
                function gtag(){dataLayer.push(arguments);}
                gtag('js', new Date());
                gtag('config', 'G-K0G9YRD39L');
            </script>

    <!-- Lemon Squeezy -->
            <script src="https://assets.lemonsqueezy.com/lemon.js" defer></script>

    <style>
/* ================================
             HERO SECTION
             ================================ */
          .hero {
            text-align: center;
            padding: 4rem 2rem 2rem;
        }

.hero-title {
            font-size: 3rem;
            font-weight: 800;
            background: linear-gradient(135deg, #ffffff 0%, #e0e7ff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 1rem;
        }

.hero-subtitle {
            font-size: 1.25rem;
            color: var(--text-primary);
            margin-bottom: 2rem;
        }

.toggle-view {
            display: inline-flex;
            gap: 1rem;
            background: var(--darker);
            padding: 0.5rem;
            border-radius: 12px;
            margin-bottom: 3rem;
        }

.toggle-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
        }

.toggle-btn.active {
            background: var(--primary);
            color: white;
        }

/* END HERO SECTION */


          /* ================================
             PRICING CARDS
             ================================ */
         
           .pricing-grid {
             display: grid;
             grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
             gap: 2rem;
             max-width: 1200px;
             margin: 0 auto;
             padding: 2rem;
          }

.badge {
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary);
            color: white;
            padding: 0.25rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 700;
          }

.plan-name {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 0.5rem;
          }

.plan-price {
            font-size: 3rem;
            font-weight: 800;
            color: var(--primary);
            margin: 1rem 0;
          }

.plan-price span {
            font-size: 1rem;
            color: var(--text-secondary);
            font-weight: 400;
          }

.plan-description {
            color: var(--text-secondary);
            margin-bottom: 2rem;
            min-height: 3rem;
          }

.features-list {
            list-style: none;
            margin: 1.5rem 0;

            /* ‚úÖ Gives the list room so CTA can anchor at bottom */
            flex: 1;
          }

.features-list li {
            padding: 0.75rem 0;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 0.25rem;
          }

.features-list li::before {
            content: '‚úì';
            color: var(--secondary);
            font-weight: bold;
            font-size: 1.25rem;
          }

/* Founder special visual */
        .price-card.founder {
          border-color: var(--primary);
          box-shadow: 0 0 0 1px rgba(139, 92, 246, 0.35), var(--shadow-md);
        }

/* ================================
             CTA BUTTON FIX (Pricing Page)
             - makes buttons obvious
             - pins button to bottom of card
             ================================ */
          .price-card .btn {
            margin-top: auto;       /* ‚úÖ push CTA to bottom */
            width: 90%;            /* ‚úÖ full-width CTA */
          }

/* ================================
             COMPARISON TABLE
             ================================ */
          .comparison-section {
            max-width: 1200px;
            margin: 4rem auto;
            padding: 2rem;
          }

.section-title {
            text-align: center;
            font-size: 2rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 2rem;
          }

.comparison-table {
            background: var(--darker);
            border: 2px solid var(--border);
            border-radius: 16px;
            overflow: hidden;
          }

.comparison-table table {
            width: 100%;
            border-collapse: collapse;
          }

.comparison-table th,
          .comparison-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
          }

.comparison-table th {
            background: var(--dark);
            color: var(--primary);
            font-weight: 600;
          }

.comparison-table td {
            color: var(--text);
          }

.checkmark {
            color: var(--secondary);
            font-weight: bold;
          }

/* END COMPARISON TABLE */


          /* ================================
             CTA SECTION
             ================================ */
          .cta-section {
            text-align: center;
            padding: 4rem 2rem;
            max-width: 700px;
            margin: 0 auto;
          }

.cta-card {
            background: var(--darker);
            border: 2px solid var(--primary);
            border-radius: 16px;
            padding: 3rem;
          }

.cta-title {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 1rem;
          }

.cta-text {
            color: var(--text-secondary);
            margin-bottom: 2rem;
            font-size: 1rem;
          }

.cta-link {
            display: inline-block;
            padding: 1rem 2rem;
            background: transparent;
            border: 2px solid var(--primary);
            border-radius: 8px;
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
          }

.cta-link:hover {
            background: var(--primary);
            color: white;
          }

/* END CTA SECTION */
</style>

</head>
<body>
<!-- Header -->
<header class="header">
    <div class="nav-container">
        <a href="/" class="logo">DMTools.fun</a>
        <div class="auth-buttons" id="authButtons">
            <button class="mobile-menu-btn" onclick="toggleMobileMenu()" aria-label="Menu">‚ò∞</button>
            <a href="#" data-auth="login" class="btn btn-secondary">Sign In</a>
            <a href="#" data-auth="register" class="btn btn-primary">Sign Up</a>
        </div>
    </div>
    
    <nav class="mobile-nav" id="mobileNav">
        <a href="/app.html" class="tab-btn">Generator</a>
        <a href="/presets.html" class="tab-btn">Templates</a>
        <a href="/packs.html" class="tab-btn">Response Packs</a>
        <a href="/pricing.html" class="tab-btn">Pricing</a>
</nav>
</header>
    
    <!-- HERO SECTION -->
    <section class="hero">
        <h1 class="hero-title">üíé Choose Your Plan</h1>
        <p class="hero-subtitle">batch processing + monthly extension responses</p>
       <div class="toggle-view">
  <button class="toggle-btn active" type="button" id="btnShowSubs" onclick="showPricingView('subs')">
    Monthly Subscriptions
  </button>
  <button class="toggle-btn" type="button" id="btnShowPacks" onclick="showPricingView('packs')">
    Response Packs ‚Üí
  </button>
</div>
   </section>
        

    <!-- END HERO SECTION -->
    
    <!-- PRICING CARDS -->
   <section class="pricing-grid" id="subsSection">

        
        <!-- Starter Plan -->
        <div class="price-card">
            <div class="plan-name">Starter</div>
            <div class="plan-price">$19<span>/month</span></div>
            <div class="plan-description">Perfect for getting started with DMTools</div>
            
            <ul class="features-list">
                <li>free 500 response pack monthly</li>
                <li>tone and context settings</li>
                <li>pay weekly or monthly</li>
                <li>5 custom templates</li>
            </ul>
            
            <button class="btn btn-primary" onclick="handleSubscriptionPurchase('starter', 'monthly')">
                Choose
                Starter
            </button>
        </div>
        
        <!-- Pro Plan -->
        <div class="price-card featured">
            <div class="badge">‚≠ê Most Popular</div>
            <div class="plan-name">Pro</div>
            <div class="plan-price">$59<span>/month</span></div>
            <div class="plan-description">7-day free trial</div>
            
            <ul class="features-list">
                <li>free 2,000 response pack monthly</li>
                <li>tone and context settings</li>
                <li>pay weekly monthly or annual (25% 0ff for picking the annual plan</li>
                <li>20 custom user preset templates</li>
                <li>7-day free trial</li>
                
            </ul>
            
            <button class="btn btn-primary" onclick="handleSubscriptionPurchase('pro', 'monthly')">
                Choose Pro
            </button>
        </div>
        
        <!-- Business Plan -->
        <div class="price-card">
            <div class="plan-name">Business</div>
            <div class="plan-price">$149<span>/month</span></div>
            <div class="plan-description">7-day Free Trial</div>
            
            <ul class="features-list">
                <li>free 8,000 response pack monthly</li>
                <li>tone and context settings</li>
                <li>pay weekly monthly or annual (25% 0ff for picking the annual plan</li>
                <li>200 custom templates</li>
                <li>7-day Free Trial</li>
           
            </ul>
            
            <button class="btn btn-primary" onclick="handleSubscriptionPurchase('business', 'monthly')">
                Choose Business
            </button>
        </div>
        
        <!-- Enterprise Plan -->
        <div class="price-card">
            <div class="badge">üöÄ Unlimited</div>
            <div class="plan-name">Enterprise</div>
            <div class="plan-price">$399<span>/month</span></div>
            <div class="plan-description">For power users and large teams</div>
            
            <ul class="features-list">
                <li>unlimited response generation (truely unlimited response generation no need for response packs)</li>
                <li>unlimited right-click sidekick responses</li>
                <li>unlimited batch limits</li>
                <li>Unlimited custom templates</li>
                <li>pay one monthly or annual price for unlimited responses, batch processing or with the Right-Click SideKick</li>
           
            </ul>
            
            <button class="btn btn-primary" onclick="handleSubscriptionPurchase('enterprise', 'monthly')">
                Choose Enterprise
            </button>
        </div>
        
    </section>
    <!-- END PRICING CARDS -->


        <!-- PACKS SECTION (Unified page) -->


<section class="pricing-grid" id="packsSection" style="display:none;">

  <!-- Founder Special Pack -->
<div class="price-card founder">
  <div class="badge">üî• Founder Special</div>
  <div class="plan-name">First Users Pack</div>
  <div class="plan-price">$3.99</div>
  <div class="plan-description">Founders special price for early adopters</div>

  <ul class="features-list">
    <li>300 responses</li>
    <li>Responses roll over</li>
    <li>Expires 6 months after activation</li>
  </ul>

  <button class="btn btn-primary" onclick="handlePackPurchase('founder')">
    buy now before founder pricing ends
  </button>
</div>

    
  <!-- Starter Pack -->
  <div class="price-card">
    <div class="plan-name">Starter Pack</div>
    <div class="plan-price">$9.99</div>
    <div class="plan-description">Perfect for light usage and trying packs</div>

    <ul class="features-list">
      <li>500 responses</li>
      <li>Responses roll over</li>
      <li>Expires 6 months after activation</li>
    </ul>

    <button class="btn btn-primary" onclick="handlePackPurchase('starter')">
      Buy Starter Pack
    </button>
  </div>

  <!-- Pro Pack -->
  <div class="price-card featured">
    <div class="badge">‚≠ê Best Value</div>
    <div class="plan-name">Pro Pack</div>
    <div class="plan-price">$16.99</div>
    <div class="plan-description">Most popular pack size</div>

    <ul class="features-list">
      <li>2,000 responses</li>
      <li>Responses roll over</li>
      <li>Expires 6 months after activation</li>
    </ul>

    <button class="btn btn-primary" onclick="handlePackPurchase('pro')">
      Buy Pro Pack
    </button>
  </div>

  <!-- Business Pack -->
  <div class="price-card">
    <div class="plan-name">Business Pack</div>
    <div class="plan-price">$34.99</div>
    <div class="plan-description">High volume packs for power users</div>

    <ul class="features-list">
      <li>8,000 responses</li>
      <li>Responses roll over</li>
      <li>Expires 6 months after activation</li>
    </ul>

    <button class="btn btn-primary" onclick="handlePackPurchase('business')">
      Buy Business Pack
    </button>
  </div>

      


</section>
    <!-- END PACKS SECTION -->
   <!-- Footer -->
<footer class="footer">
    <div class="container">
        <div class="footer-content">
            <div class="footer-brand">
                <h3 class="footer-logo">DMTools.fun</h3>
                <p class="footer-description">
                    AI-powered universal messaging response generator.
                </p>
            </div>
            
            <div class="footer-links">
                <div class="link-group">
                    <h4>Product</h4>
                    <a href="/app.html">Generator</a>
                    <a href="/presets.html">Templates</a>
                    <a href="/pricing.html">Pricing</a>
                    <a href="/store.html">Packs Store</a>
                </div>
                
                <div class="link-group">
                    <h4>Legal</h4>
                    <a href="/terms-of-service.html">Terms of Service</a>
                    <a href="/privacy-policy.html">Privacy Policy</a>
                    <a href="/refund-policy.html">Refund Policy</a>
                    <a href="/cookie-policy.html">Cookie Policy</a>
                </div>
                
                <div class="link-group">
                    <h4>Support</h4>
                    <a href="/contact.html">Contact Us</a>
                    <a href="mailto:admin@dmtools.fun">Email Support</a>
                </div>
            </div>
        </div>
        
        <div class="footer-bottom">
            <p class="footer-copyright">¬© 2025 DMTools.fun LLC. All rights reserved.</p>
        </div>
    </div>
</footer>
    <!-- END FOOTER -->
    
    <script>
        // =============================================
        // SUBSCRIPTION CHECKOUT - WORKING VERSION
        // Updated: December 4, 2025
        // =============================================

    // Mobile menu toggle
    function toggleMobileMenu() {
        document.getElementById('mobileNav').classList.toggle('show');
    }
// ----------------------------
// [BANNER-PRC-001] PRICING CONFIG + CHECKOUT (billing entrypoint)
// ----------------------------

        const API_BASE = 'https://dmtools-backend-production.up.railway.app/api';

        // ----------------------------
// GA4 helpers (safe wrappers)
function gaEvent(name, params) {
  try {
    if (typeof gtag === 'function') gtag('event', name, params || {});
  } catch (e) {}
}

        // ----------------------------
// GA4: LemonSqueezy Checkout.Success => purchase
(function initLemonGaPurchaseTracker() {
  if (window.__dm_ls_ga_purchase_init) return;
  window.__dm_ls_ga_purchase_init = true;

  function getOrderField(order, key) {
    if (!order) return undefined;
    if (order[key] != null) return order[key];
    if (order.data && order.data.attributes && order.data.attributes[key] != null) return order.data.attributes[key];
    if (order.attributes && order.attributes[key] != null) return order.attributes[key];
    return undefined;
  }

  function wasOrderSeen(id) {
    try { return sessionStorage.getItem('dm_last_order_id') === String(id || ''); } catch (_) { return false; }
  }

  function markOrderSeen(id) {
    try { sessionStorage.setItem('dm_last_order_id', String(id || '')); } catch (_) {}
  }

  function readCheckoutContext() {
    try {
      const raw = sessionStorage.getItem('dm_last_checkout');
      return raw ? JSON.parse(raw) : null;
    } catch (_) { return null; }
  }

  function firePurchase(order) {
    if (typeof gtag !== 'function') return;

    const identifier =
      getOrderField(order, 'identifier') ||
      getOrderField(order, 'order_number') ||
      getOrderField(order, 'id');

    if (!identifier || wasOrderSeen(identifier)) return;

    const currency = getOrderField(order, 'currency') || 'USD';
    const totalCents = getOrderField(order, 'total');

    const ctx = readCheckoutContext() || {};
    const value = (typeof totalCents === 'number') ? (totalCents / 100) : ctx.value;

    gtag('event', 'purchase', {
      transaction_id: String(identifier),
      currency: currency,
      value: value,
      items: ctx.items
    });

    markOrderSeen(identifier);
  }

  function setupWhenReady() {
    if (window.LemonSqueezy && typeof window.LemonSqueezy.Setup === 'function') {
      window.LemonSqueezy.Setup({
        eventHandler: (evt) => {
          if (evt && evt.event === 'Checkout.Success') {
            firePurchase(evt.data);
          }
        }
      });
      return;
    }
    setTimeout(setupWhenReady, 250);
  }

  setupWhenReady();
})();


const PRICING_STATE = {
  loaded: false,
  subscriptionsByKey: {},
  packsByKey: {}
};

const SUBSCRIPTION_ORDER = ['starter', 'pro', 'business', 'enterprise'];
const PACK_ORDER = ['starter', 'pro', 'business', 'founder'];

function escapeHtml(str) {
  return String(str || '')
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}

function formatUsd(amount) {
  const value = Number(amount);
  if (!Number.isFinite(value)) return '$0.00';
  return `$${value.toFixed(2)}`;
}

function normalizePricingCatalog(payload) {
  const plans = payload?.plans && typeof payload.plans === 'object' ? payload.plans : {};
  const packs = payload?.packs && typeof payload.packs === 'object' ? payload.packs : {};
  const normalized = { subscriptionsByKey: {}, packsByKey: {} };

  Object.entries(plans).forEach(([rawKey, plan]) => {
    const key = String(plan?.key || rawKey || '').toLowerCase();
    if (!key || key === 'free') return;

    const variantId = String(plan?.variantId || plan?.variant_id || '').trim();
    if (!variantId) return;

    const billingInterval = String(plan?.billing_interval || plan?.interval || 'month').toLowerCase();
    const amount = Number(plan?.price_amount ?? plan?.price ?? plan?.price?.amount ?? 0);
    const currency = plan?.currency || plan?.price?.currency || payload?.currency || 'USD';
    const baseKey = key.replace(/_(weekly|monthly|annual|yearly)$/i, '');

    normalized.subscriptionsByKey[key] = {
      key,
      baseKey,
      displayName: plan?.display_name || plan?.name || baseKey,
      variantId,
      billingInterval,
      priceAmount: Number.isFinite(amount) ? amount : 0,
      currency,
      features: Array.isArray(plan?.features) ? plan.features : [],
      limits: plan?.limits || null
    };
  });

  Object.entries(packs).forEach(([rawKey, pack]) => {
    const key = String(pack?.key || rawKey || '').toLowerCase();
    if (!key) return;

    const variantId = String(pack?.variantId || pack?.variant_id || '').trim();
    if (!variantId) return;

    const amount = Number(pack?.price_amount ?? pack?.price ?? pack?.price?.amount ?? 0);
    const currency = pack?.currency || pack?.price?.currency || payload?.currency || 'USD';

    normalized.packsByKey[key] = {
      key,
      displayName: pack?.display_name || pack?.name || `${key} pack`,
      variantId,
      responses: Number(pack?.responses || 0),
      priceAmount: Number.isFinite(amount) ? amount : 0,
      currency,
      features: Array.isArray(pack?.features) ? pack.features : []
    };
  });

  return normalized;
}

function getMonthlySubscription(baseKey) {
  const preferred = PRICING_STATE.subscriptionsByKey[baseKey];
  if (preferred && preferred.billingInterval === 'month') return preferred;

  const monthlyKey = `${baseKey}_monthly`;
  const monthly = PRICING_STATE.subscriptionsByKey[monthlyKey];
  if (monthly) return monthly;

  const any = Object.values(PRICING_STATE.subscriptionsByKey).find((item) => item.baseKey === baseKey);
  return any || null;
}

function showPricingLoadError(message) {
  let node = document.getElementById('pricingLoadError');
  if (!node) {
    node = document.createElement('div');
    node.id = 'pricingLoadError';
    node.className = 'container';
    node.style.marginTop = '12px';
    node.style.marginBottom = '8px';
    node.innerHTML = `<div class="card" style="padding:12px 16px;color:#fecaca;border-color:#ef4444;background:rgba(239,68,68,.12);font-size:.92rem;"></div>`;
    const hero = document.querySelector('.hero');
    if (hero && hero.parentNode) {
      hero.parentNode.insertBefore(node, hero.nextSibling);
    } else {
      document.body.insertBefore(node, document.body.firstChild);
    }
  }
  const card = node.querySelector('.card');
  if (card) card.textContent = message;
}

function renderSubscriptionCards() {
  const container = document.getElementById('subsSection');
  if (!container) return;

  const details = {
    starter: { description: 'Perfect for getting started with DMTools' },
    pro: { description: '7-day free trial', badge: '‚≠ê Most Popular', featured: true },
    business: { description: '7-day Free Trial' },
    enterprise: { description: 'For power users and large teams', badge: 'üöÄ Unlimited' }
  };

  const cards = SUBSCRIPTION_ORDER
    .map((baseKey) => getMonthlySubscription(baseKey))
    .filter(Boolean)
    .map((item) => {
      const meta = details[item.baseKey] || {};
      const featureList = (item.features || [])
        .map((feature) => `<li>${escapeHtml(feature)}</li>`)
        .join('');
      const intervalLabel = item.billingInterval || 'month';
      return `
        <div class="price-card${meta.featured ? ' featured' : ''}">
          ${meta.badge ? `<div class="badge">${escapeHtml(meta.badge)}</div>` : ''}
          <div class="plan-name">${escapeHtml(item.displayName)}</div>
          <div class="plan-price">${formatUsd(item.priceAmount)}<span>/${escapeHtml(intervalLabel)}</span></div>
          <div class="plan-description">${escapeHtml(meta.description || '')}</div>
          <ul class="features-list">${featureList}</ul>
          <button class="btn btn-primary" onclick="handleSubscriptionPurchase('${escapeHtml(item.baseKey)}', '${escapeHtml(item.billingInterval)}')">
            Choose ${escapeHtml(item.displayName)}
          </button>
        </div>
      `;
    })
    .join('');

  if (cards) container.innerHTML = cards;
}

function renderPackCards() {
  const container = document.getElementById('packsSection');
  if (!container) return;

  const details = {
    starter: { description: 'Perfect for light usage and trying packs', cta: 'Buy Starter Pack' },
    pro: { description: 'Most popular pack size', cta: 'Buy Pro Pack', badge: '‚≠ê Best Value', featured: true },
    business: { description: 'High volume packs for power users', cta: 'Buy Business Pack' },
    founder: { description: 'Founders special price for early adopters', cta: 'Buy First Users Pack', badge: 'üî• Founder Special', extraClass: ' founder' }
  };

  const cards = PACK_ORDER
    .map((key) => PRICING_STATE.packsByKey[key])
    .filter(Boolean)
    .map((item) => {
      const meta = details[item.key] || {};
      const features = (item.features || [])
        .map((feature) => `<li>${escapeHtml(feature)}</li>`)
        .join('');
      return `
        <div class="price-card${meta.featured ? ' featured' : ''}${meta.extraClass || ''}">
          ${meta.badge ? `<div class="badge">${escapeHtml(meta.badge)}</div>` : ''}
          <div class="plan-name">${escapeHtml(item.displayName)}</div>
          <div class="plan-price">${formatUsd(item.priceAmount)}</div>
          <div class="plan-description">${escapeHtml(meta.description || '')}</div>
          <ul class="features-list">${features}</ul>
          <button class="btn btn-primary" onclick="handlePackPurchase('${escapeHtml(item.key)}')">
            ${escapeHtml(meta.cta || `Buy ${item.displayName}`)}
          </button>
        </div>
      `;
    })
    .join('');

  if (cards) container.innerHTML = cards;
}

async function loadPricingCatalog() {
  try {
    const response = await fetch(`${API_BASE}/subscription/pricing`);
    const data = await response.json();

    if (!response.ok) {
      throw new Error(data?.error || 'Failed to load pricing');
    }

    const normalized = normalizePricingCatalog(data);
    PRICING_STATE.subscriptionsByKey = normalized.subscriptionsByKey;
    PRICING_STATE.packsByKey = normalized.packsByKey;
    PRICING_STATE.loaded = true;

    renderSubscriptionCards();
    renderPackCards();
    return true;
  } catch (error) {
    console.error('Pricing fetch failed:', error);
    showPricingLoadError('Pricing is temporarily unavailable. Showing fallback display values.');
    return false;
  }
}

// ----------------------------
// Guest checkout helper (email capture for webhook mapping)
function promptCheckoutEmailOrNull() {
  const raw = prompt('Enter your email to receive your receipt and to claim your responses after purchase:', '');
  if (raw === null) return null;
  const email = String(raw).trim().toLowerCase();
  const ok = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
  if (!ok) return null;
  return email;
}

function getSubscriptionForCheckout(plan, interval) {
  const planKey = String(plan || '').toLowerCase();
  const intervalKey = String(interval || '').toLowerCase();
  const direct = PRICING_STATE.subscriptionsByKey[`${planKey}_${intervalKey}`];
  if (direct) return direct;
  const fallback = PRICING_STATE.subscriptionsByKey[planKey];
  if (fallback) return fallback;
  return getMonthlySubscription(planKey);
}

async function handleSubscriptionPurchase(plan, interval) {
  const subscription = getSubscriptionForCheckout(plan, interval);
  if (!subscription || !subscription.variantId) {
    alert('Pricing is still loading. Please try again.');
    return;
  }

  const variantId = subscription.variantId;
  const planKey = subscription.baseKey || String(plan || '').toLowerCase();
  const planInterval = subscription.billingInterval || String(interval || '').toLowerCase() || 'month';
  const planName = subscription.displayName || planKey;
  const price = subscription.priceAmount || 0;
  const currency = subscription.currency || 'USD';

  const token = localStorage.getItem('authToken');
  let userId = null;
  let checkoutEmail = '';

  if (token) {
    try {
      const tokenParts = token.split('.');
      const payload = JSON.parse(atob(tokenParts[1]));
      userId = payload.id || payload.userId || null;
      checkoutEmail = payload.email || '';
      if (!userId) userId = null;
    } catch (e) {
      userId = null;
      checkoutEmail = '';
    }
  }

  if (!checkoutEmail) {
    const guestEmail = promptCheckoutEmailOrNull();
    if (!guestEmail) {
      alert('Email is required to continue checkout.');
      return;
    }
    checkoutEmail = guestEmail;
    try { localStorage.setItem('dm_guest_checkout_email', checkoutEmail); } catch (_) {}
  }

  let checkoutUrl = '';
  try {
    const headers = { 'Content-Type': 'application/json' };
    if (token) headers['Authorization'] = `Bearer ${token}`;

    const response = await fetch(`${API_BASE}/checkout/create`, {
      method: 'POST',
      headers,
      body: JSON.stringify({
        kind: 'subscription',
        variantId,
        email: checkoutEmail || undefined
      })
    });

    const data = await response.json().catch(() => ({}));
    if (!response.ok || !data.url) {
      throw new Error(data.error || 'Failed to create checkout URL');
    }

    checkoutUrl = data.url;
  } catch (error) {
    console.error('Subscription checkout URL error:', error);
    alert('Error starting checkout. Please try again.');
    return;
  }

  gaEvent('begin_checkout', {
    currency: currency,
    value: price || undefined,
    items: [{
      item_name: `${planName} Subscription`,
      item_id: `sub_${planKey}_${planInterval}`,
      item_category: 'subscription',
      price: price || undefined,
      quantity: 1
    }],
    plan_name: planKey,
    interval: planInterval,
    variant_id: variantId,
    user_id: userId || undefined,
    email: checkoutEmail || undefined
  });

  try {
    sessionStorage.setItem('dm_last_checkout', JSON.stringify({
      item_name: `${planName} Subscription`,
      item_id: `sub_${planKey}_${planInterval}`,
      item_category: 'subscription',
      value: price || undefined,
      price: price || undefined,
      currency: currency,
      items: [{
        item_name: `${planName} Subscription`,
        item_id: `sub_${planKey}_${planInterval}`,
        item_category: 'subscription',
        price: price || undefined,
        quantity: 1
      }]
    }));
  } catch (e) {}

  if (window.LemonSqueezy && window.LemonSqueezy.Url) {
    window.LemonSqueezy.Url.Open(checkoutUrl);
  } else {
    window.open(checkoutUrl, '_blank');
  }
}

// =============================================
// UNIFIED PAGE VIEW TOGGLE (Subs <-> Packs)
// =============================================
function showPricingView(view) {
  const subs = document.getElementById('subsSection');
  const packs = document.getElementById('packsSection');
  const packsHero = document.getElementById('packsHero');
  const btnSubs = document.getElementById('btnShowSubs');
  const btnPacks = document.getElementById('btnShowPacks');

  if (!subs || !packs || !btnSubs || !btnPacks) return;

  if (view === 'packs') {
    subs.style.display = 'none';
    packs.style.display = '';
    if (packsHero) packsHero.style.display = '';
    btnSubs.classList.remove('active');
    btnPacks.classList.add('active');
    packs.scrollIntoView({ behavior: 'smooth', block: 'start' });
  } else {
    subs.style.display = '';
    packs.style.display = 'none';
    if (packsHero) packsHero.style.display = 'none';
    btnPacks.classList.remove('active');
    btnSubs.classList.add('active');
    subs.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }

  if (typeof gtag === 'function') {
    gtag('event', 'pricing_view_switch', { view: view });
  }
}

async function handlePackPurchase(packName) {
  const key = String(packName || '').toLowerCase();
  const packInfo = PRICING_STATE.packsByKey[key];

  if (!packInfo || !packInfo.variantId) {
    alert('Pricing is still loading. Please try again.');
    return;
  }

  function promptForEmail() {
    const email = prompt(
      'Enter your email for delivery/account linking (you can create your account after purchase):'
    );
    if (!email) return null;
    const trimmed = String(email).trim();
    const ok = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(trimmed);
    if (!ok) {
      alert('Please enter a valid email address.');
      return null;
    }
    return trimmed;
  }

  const token = localStorage.getItem('authToken');
  let userId = null;
  let emailForCheckout = '';

  if (token) {
    try {
      const tokenParts = token.split('.');
      const payload = JSON.parse(atob(tokenParts[1]));
      userId = payload.id || payload.userId || null;
      emailForCheckout = payload.email || '';
    } catch (e) {
      console.warn('Token decode failed, continuing as guest:', e);
      userId = null;
      emailForCheckout = '';
    }
  }

  if (!userId) {
    const guestEmail = promptForEmail();
    if (!guestEmail) {
      alert('Please sign in or enter an email to continue.');
      if (window.DMTOOLS?.openAuthModal) {
        window.DMTOOLS.openAuthModal('login');
      }
      return;
    }
    emailForCheckout = guestEmail;
    try { localStorage.setItem('pendingGuestEmail', emailForCheckout); } catch (_) {}
  }

  let checkoutUrl = '';
  try {
    const headers = { 'Content-Type': 'application/json' };
    if (token) headers['Authorization'] = `Bearer ${token}`;

    const response = await fetch(`${API_BASE}/checkout/create`, {
      method: 'POST',
      headers,
      body: JSON.stringify({
        kind: 'pack',
        variantId: packInfo.variantId,
        email: emailForCheckout || undefined
      })
    });

    const data = await response.json().catch(() => ({}));
    if (!response.ok || !data.url) {
      throw new Error(data.error || 'Failed to create checkout URL');
    }

    checkoutUrl = data.url;
  } catch (error) {
    console.error('Pack checkout URL error:', error);
    alert('Error starting checkout. Please try again.');
    return;
  }

  try {
    if (typeof gtag === 'function') {
      gtag('event', 'begin_checkout', {
        currency: packInfo.currency || 'USD',
        value: packInfo.priceAmount,
        pack_name: packInfo.displayName,
        pack_key: key,
        user_id: userId || undefined,
        email: emailForCheckout || undefined,
        items: [{
          item_name: packInfo.displayName,
          item_id: `pack_${key}`,
          item_category: 'pack',
          price: packInfo.priceAmount,
          quantity: 1
        }]
      });
    }
  } catch (e) {}

  try {
    sessionStorage.setItem('dm_last_checkout', JSON.stringify({
      item_name: packInfo.displayName,
      item_id: `pack_${key}`,
      item_category: 'pack',
      value: packInfo.priceAmount,
      price: packInfo.priceAmount,
      currency: packInfo.currency || 'USD',
      items: [{
        item_name: packInfo.displayName,
        item_id: `pack_${key}`,
        item_category: 'pack',
        price: packInfo.priceAmount,
        quantity: 1
      }]
    }));
  } catch (e) {}

  try {
    if (window.LemonSqueezy && window.LemonSqueezy.Url) {
      window.LemonSqueezy.Url.Open(checkoutUrl);
    } else {
      window.open(checkoutUrl, '_blank');
    }
  } catch (error) {
    console.error('Pack checkout error:', error);
    alert('Error starting checkout. Please try again.');
  }
}

function checkPendingPackPurchase() {
  const pending = localStorage.getItem('pendingPackPurchase');
  if (!pending) return;

  localStorage.removeItem('pendingPackPurchase');
  showPricingView('packs');

  const packInfo = PRICING_STATE.packsByKey[pending];
  if (packInfo) {
    setTimeout(() => handlePackPurchase(pending), 500);
  }
}

        // Check for pending purchase after login
        function checkPendingPurchase() {
            const pending = localStorage.getItem('pendingPurchase');
            if (pending) {
                try {
                    const { plan, interval } = JSON.parse(pending);
                    localStorage.removeItem('pendingPurchase');
                    setTimeout(() => {
                        handleSubscriptionPurchase(plan, interval);
                    }, 500);
                } catch (e) {
                    localStorage.removeItem('pendingPurchase');
                }
            }
        }
        
       // Check authentication and update header
async function updateAuthSection() {
  const token = localStorage.getItem('authToken');
  const authSection = document.getElementById('authButtons'); // ‚úÖ fix: correct element id

  if (!authSection) return;

  const menuBtnHtml = `<button class="mobile-menu-btn" onclick="toggleMobileMenu()" aria-label="Menu">‚ò∞</button>`;

  if (!token) {
    authSection.innerHTML = `
      ${menuBtnHtml}
      <a href="#" data-auth="login" class="btn btn-secondary">Sign In</a>
      <a href="#" data-auth="register" class="btn btn-primary">Sign Up</a>
    `;
    return;
  }

  try {
    const response = await fetch(API_BASE + '/user/profile', {
      headers: { 'Authorization': `Bearer ${token}` }
    });

    if (!response.ok) {
      localStorage.removeItem('authToken');
      authSection.innerHTML = `
        ${menuBtnHtml}
        <a href="#" data-auth="login" class="btn btn-secondary">Sign In</a>
        <a href="#" data-auth="register" class="btn btn-primary">Sign Up</a>
      `;
      return;
    }

    const data = await response.json();
    const user = data.user;

    authSection.innerHTML = `
      ${menuBtnHtml}
      <div class="user-section">
        <span class="user-email">${user.email}</span>
<button class="btn btn-primary" onclick="handleLogout()">Logout</button>
      </div>
    `;

    checkPendingPurchase();
  } catch (error) {
    console.error('Auth check failed:', error);
    authSection.innerHTML = `
      ${menuBtnHtml}
      <a href="#" data-auth="login" class="btn btn-secondary">Sign In</a>
      <a href="#" data-auth="register" class="btn btn-primary">Sign Up</a>
    `;
  }
}

        
        function handleLogout() {
            localStorage.removeItem('authToken');
            window.location.href = '/';
        }
        
  document.addEventListener('DOMContentLoaded', async function() {
  if (window.createLemonSqueezy) {
    window.createLemonSqueezy();
  }

  await loadPricingCatalog();

  if (window.location.hash === '#packs') {
    showPricingView('packs');
  }

  checkPendingPackPurchase();
  updateAuthSection();
});

        // ----------------------------
// Make sure inline onclick handlers can always find these
try {
  window.toggleMobileMenu = toggleMobileMenu;
  window.handleSubscriptionPurchase = handleSubscriptionPurchase;
  window.showPricingView = showPricingView;
  window.handlePackPurchase = handlePackPurchase;
} catch (e) {}


            
         
    </script>
<script src="js/app-core.js"></script>
<script src="js/auth-modal.js"></script>
</body>
</html>

